<!DOCTYPE html>

<html lang="ja">

<head>

Â  Â  <meta charset="UTF-8" />

Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

Â  Â  <title>ã­ã“ãƒãƒˆãƒ«ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>

Â  Â  <link rel="preconnect" href="https://fonts.googleapis.com">

Â  Â  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

Â  Â  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">

Â  Â  <style>

Â  Â  Â  Â  /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ç­‰ --- */

Â  Â  Â  Â  body {

Â  Â  Â  Â  Â  Â  font-family: 'M PLUS Rounded 1c', sans-serif;

Â  Â  Â  Â  Â  Â  text-align: center;

Â  Â  Â  Â  Â  Â  background-color: #fdf6e3; /* é€šå¸¸èƒŒæ™¯ */

Â  Â  Â  Â  Â  Â  margin: 0;

Â  Â  Â  Â  Â  Â  padding: 15px;

Â  Â  Â  Â  Â  Â  transition: background-color 0.3s ease-out;

Â  Â  Â  Â  Â  Â  position: relative; /* ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤ºã®ä½ç½®åŸºæº–ç”¨ */

Â  Â  Â  Â  Â  Â  min-height: 100vh;

Â  Â  Â  Â  Â  Â  box-sizing: border-box;

Â  Â  Â  Â  Â  Â  overflow-x: hidden; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */

Â  Â  Â  Â  }

Â  Â  Â  Â  body.boss-battle-bg {

Â  Â  Â  Â  Â  Â  background-color: #ffebee; /* ãƒœã‚¹æˆ¦èƒŒæ™¯ */

Â  Â  Â  Â  }

Â  Â  Â  Â  body.training-bg {

Â  Â  Â  Â  Â  Â  background-color: #e3f2fd; /* ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°èƒŒæ™¯ */

Â  Â  Â  Â  }



Â  Â  Â  Â  h1 {

Â  Â  Â  Â  Â  Â  font-size: 1.8em;

Â  Â  Â  Â  Â  Â  color: #d35400; /* ã‚ªãƒ¬ãƒ³ã‚¸ç³» */

Â  Â  Â  Â  Â  Â  margin-bottom: 10px;

Â  Â  Â  Â  Â  Â  font-weight: 700;

Â  Â  Â  Â  }

Â  Â  Â  Â  button {

Â  Â  Â  Â  Â  Â  font-family: 'M PLUS Rounded 1c', sans-serif;

Â  Â  Â  Â  Â  Â  font-weight: bold;

Â  Â  Â  Â  Â  Â  cursor: pointer;

Â  Â  Â  Â  Â  Â  transition: background-color 0.2s, transform 0.1s;

Â  Â  Â  Â  Â  Â  border: none;

Â  Â  Â  Â  }

Â  Â  Â  Â  button:active:not(:disabled) {

Â  Â  Â  Â  Â  Â  Â transform: scale(0.97);

Â  Â  Â  Â  }

Â  Â  Â  Â  button:disabled {

Â  Â  Â  Â  Â  Â  Â cursor: not-allowed;

Â  Â  Â  Â  Â  Â  Â opacity: 0.6;

Â  Â  Â  Â  }



Â  Â  Â  Â  /* --- BGMãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ --- */

Â  Â  Â  Â  #bgmToggleBtn {

Â  Â  Â  Â  Â  Â  position: absolute;

Â  Â  Â  Â  Â  Â  top: 15px;

Â  Â  Â  Â  Â  Â  right: 15px;

Â  Â  Â  Â  Â  Â  font-size: 1.8em;

Â  Â  Â  Â  Â  Â  background: none;

Â  Â  Â  Â  Â  Â  border: none;

Â  Â  Â  Â  Â  Â  padding: 5px;

Â  Â  Â  Â  Â  Â  opacity: 0.7;

Â  Â  Â  Â  Â  Â  z-index: 20; /* ä»–ã®è¦ç´ ã‚ˆã‚Šæ‰‹å‰ã« */

Â  Â  Â  Â  }

Â  Â  Â  Â  #bgmToggleBtn:hover {

Â  Â  Â  Â  Â  Â  Â opacity: 1;

Â  Â  Â  Â  }

Â  Â  Â  Â  /* mutedã‚¯ãƒ©ã‚¹ã§ã‚¢ã‚¤ã‚³ãƒ³åˆ‡ã‚Šæ›¿ãˆ */

Â  Â  Â  Â  #bgmToggleBtn.muted::before { content: "ğŸ”‡"; font-size: 1em; }

Â  Â  Â  Â  #bgmToggleBtn:not(.muted)::before { content: "ğŸ”Š"; font-size: 1em; }



Â  Â  Â  Â  /* --- ç”»é¢ã‚³ãƒ³ãƒ†ãƒŠ --- */

Â  Â  Â  Â  .screen {

Â  Â  Â  Â  Â  Â  display: none; /* åŸºæœ¬ã¯éè¡¨ç¤º */

Â  Â  Â  Â  Â  Â  padding-top: 30px;

Â  Â  Â  Â  Â  Â  flex-direction: column;

Â  Â  Â  Â  Â  Â  align-items: center;

Â  Â  Â  Â  Â  Â  gap: 10px;

Â  Â  Â  Â  Â  Â  width: 100%;

Â  Â  Â  Â  }

Â  Â  Â  Â  #modeSelectScreen { display: flex; } /* åˆæœŸè¡¨ç¤º */



Â  Â  Â  Â  /* --- ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ --- */

Â  Â  Â  Â  #modeSelectScreen h2 { font-size: 1.5em; color: #555; margin-bottom: 10px; }

Â  Â  Â  Â  .mode-btn { font-size: 1.1em; padding: 10px 25px; border-radius: 18px; color: white; min-width: 200px; margin-bottom: 5px; }

Â  Â  Â  Â  #grade1ModeBtn { background-color: #87cefa; } #grade2ModeBtn { background-color: #ffb6c1; } #grade3ModeBtn { background-color: #90ee90; } #grade4ModeBtn { background-color: #ffcc80; } #grade5ModeBtn { background-color: #ba55d3; } #trainingModeBtn { background-color: #ff7f50; }

Â  Â  Â  Â  #grade1ModeBtn:hover { background-color: #5abcd8; } #grade2ModeBtn:hover { background-color: #ff9aaa; } #grade3ModeBtn:hover { background-color: #66cdab; } #grade4ModeBtn:hover { background-color: #ffa726; } #grade5ModeBtn:hover { background-color: #9932cc; } #trainingModeBtn:hover { background-color: #ff6347; }



Â  Â  Â  Â  /* --- ã‚¹ã‚¿ãƒ¼ãƒˆæ–¹æ³•é¸æŠç”»é¢ --- */

Â  Â  Â  Â  #startMethodScreen h2 { font-size: 1.5em; color: #555; }

Â  Â  Â  Â  .start-method-btn { font-size: 1.4em; padding: 15px 40px; border-radius: 25px; color: white; min-width: 250px; }

Â  Â  Â  Â  #startFromBeginningBtn { background-color: #a5d6a7; } #continueFromLastBtn { background-color: #90caf9; }

Â  Â  Â  Â  #startFromBeginningBtn:hover { background-color: #81c784; } #continueFromLastBtn:hover:not(:disabled) { background-color: #64b5f6; }



Â  Â  Â  Â  /* --- ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¿ã‚¤ãƒ—é¸æŠç”»é¢ --- */

Â  Â  Â  Â  #trainingTypeSelectScreen { gap: 15px; }

Â  Â  Â  Â  #trainingTypeSelectScreen h2 { font-size: 1.5em; color: #555; }

Â  Â  Â  Â  .training-type-btn { font-size: 1.2em; padding: 12px 30px; border-radius: 20px; color: white; min-width: 280px; background-color: #4db6ac; }

Â  Â  Â  Â  Â .training-type-btn:hover { background-color: #26a69a; }

Â  Â  Â  Â  #backToModeSelectBtn { font-size: 1em; padding: 8px 20px; background-color: #bdbdbd; color: #fff; border-radius: 15px; margin-top: 10px; } /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */

Â  Â  Â  Â  #backToModeSelectBtn:hover { background-color: #9e9e9e;}



Â  Â  Â  Â  /* --- ãƒãƒˆãƒ«ç”»é¢ --- */

Â  Â  Â  Â  #battleScreen { gap: 10px; }

Â  Â  Â  Â  .character-area { border: 2px solid #eee; border-radius: 10px; padding: 10px; margin: 5px 0; width: 90%; max-width: 400px; background-color: rgba(255, 255, 255, 0.8); box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; }

Â  Â  Â  Â  #enemyArea { border-color: #e74c3c; }

Â  Â  Â  Â  #playerArea { border-color: #3498db; }

Â  Â  Â  Â  .character-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-weight: bold; }

Â  Â  Â  Â  .character-name { font-size: 1.1em; }

Â  Â  Â  Â  .character-hp-text { font-size: 1em; }

Â  Â  Â  Â  .hp-bar-container { height: 15px; background-color: #eee; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; }

Â  Â  Â  Â  .hp-bar { height: 100%; width: 100%; border-radius: 6px; transition: width 0.3s ease-in-out; }

Â  Â  Â  Â  #enemyArea .hp-bar { background-color: #f44336; }

Â  Â  Â  Â  #playerArea .hp-bar { background-color: #4caf50; }

Â  Â  Â  Â  .character-display { font-size: 3em; margin: 5px 0; transition: transform 0.1s ease-in-out, opacity 0.3s ease-out; opacity: 1; }

Â  Â  Â  Â  .character-display.defeated { opacity: 0; transform: scale(0.5) rotate(30deg); }

Â  Â  Â  Â  #question { font-size: 2.2em; margin: 15px 0; color: #2c3e50; font-weight: 700; min-height: 1.3em; }

Â  Â  Â  Â  #answerChoices { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 10px; margin-bottom: 10px; }

Â  Â  Â  Â  .choice-btn { font-size: 1.3em; padding: 10px 18px; border-radius: 8px; border: 2px solid #f39c12; background-color: #fff; color: #333; min-width: 70px; }

Â  Â  Â  Â  .choice-btn:hover:not(:disabled) { background-color: #fef9e7; }

Â  Â  Â  Â  .choice-btn:disabled { background-color: #eee; border-color: #ccc; color: #aaa; }

Â  Â  Â  Â  #battleLog { font-size: 1.1em; min-height: 1.5em; margin: 10px 0; color: #c0392b; font-weight: bold; }

Â  Â  Â  Â  #startBtn { font-size: 1.1em; padding: 10px 30px; margin: 15px 0 5px 0; border-radius: 20px; background-color: #e67e22; color: white; min-width: 160px; }

Â  Â  Â  Â  #startBtn:hover { background-color: #d35400; }



Â  Â  Â  Â  /* --- ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”»é¢ --- */

Â  Â  Â  Â  #trainingScreen { gap: 15px; }

Â  Â  Â  Â  #trainingStatus { display: flex; justify-content: space-around; width: 90%; max-width: 400px; font-size: 1.4em; font-weight: bold;}

Â  Â  Â  Â  #trainingTimer { color: #ff9800; }

Â  Â  Â  Â  #trainingScore { color: #4caf50; }

Â  Â  Â  Â  #trainingEnemyDisplay { font-size: 4em; margin: 10px 0; transition: opacity 0.2s, transform 0.2s; }

Â  Â  Â  Â  #trainingEnemyDisplay.defeated { opacity: 0; transform: scale(0.5); }

Â  Â  Â  Â  #trainingQuestion { font-size: 2.5em; margin: 10px 0; color: #2c3e50; font-weight: 700; min-height: 1.3em; }

Â  Â  Â  Â  #trainingAnswerChoices { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 10px; margin-bottom: 10px; }



Â  Â  Â  Â  /* --- ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°çµæœç”»é¢ --- */

Â  Â  Â  Â  #trainingResultScreen { gap: 15px; }

Â  Â  Â  Â  #trainingResultScreen h2 { font-size: 1.8em; color: #00796b;}

Â  Â  Â  Â  #finalScore { font-size: 2.5em; font-weight: bold; color: #ff6f61; }

Â  Â  Â  Â  #personalBest { font-size: 1.2em; color: #555; }

Â  Â  Â  Â  .result-btn-area { display: flex; gap: 15px; margin-top: 15px;}

Â  Â  Â  Â  .result-btn { font-size: 1.1em; padding: 10px 25px; border-radius: 18px; color: white; min-width: 150px; }

Â  Â  Â  Â  #retryTrainingBtn { background-color: #66bb6a; }

Â  Â  Â  Â  #backToModeSelectBtnFromTraining { background-color: #bdbdbd; }

Â  Â  Â  Â  #retryTrainingBtn:hover { background-color: #4caf50; }

Â  Â  Â  Â  #backToModeSelectBtnFromTraining:hover { background-color: #9e9e9e; }



Â  Â  Â  Â  /* --- å…±é€šæ¼”å‡ºç³» --- */

Â  Â  Â  Â  #feedbackDisplay { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%) scale(0.8); font-size: 3em; font-weight: bold; color: #fff; background-color: rgba(0, 0, 0, 0.6); padding: 10px 25px; border-radius: 15px; opacity: 0; transition: opacity 0.2s ease-out, transform 0.2s ease-out; pointer-events: none; z-index: 10; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }

Â  Â  Â  Â  #feedbackDisplay.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }

Â  Â  Â  Â  #feedbackDisplay.critical { color: #ffeb3b; } #feedbackDisplay.perfect { color: #81d4fa; } #feedbackDisplay.great { color: #a5d6a7; } #feedbackDisplay.good { color: #fff; } #feedbackDisplay.slow { color: #ef9a9a; } #feedbackDisplay.wrong { color: #f44336; background-color: rgba(255, 255, 255, 0.8); text-shadow: none;}

Â  Â  Â  Â  #comboDisplay { position: absolute; top: 60%; left: 50%; transform: translateX(-50%); font-size: 2.5em; font-weight: bold; color: #ff9800; opacity: 0; transition: opacity 0.2s, transform 0.2s; pointer-events: none; z-index: 5; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }

Â  Â  Â  Â  #comboDisplay.show { opacity: 1; animation: comboBounce 0.3s ease-out; }

Â  Â  Â  Â  #comboDisplay.great-combo { color: #f44336; } #comboDisplay.amazing-combo { color: #9c27b0; }

Â  Â  Â  Â  @keyframes comboBounce { 0% { transform: translateX(-50%) scale(0.8); } 50% { transform: translateX(-50%) scale(1.1); } 100% { transform: translateX(-50%) scale(1); } }

Â  Â  Â  Â  @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px); } 50% { transform: translateX(3px); } 75% { transform: translateX(-3px); } }

Â  Â  Â  Â  .shake-animation { animation: shake 0.2s ease-in-out; }

Â  Â  Â  Â  body.feedback-flash { background-color: #fff3e0; }



/* --- ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« --- */

.damage-popup {

Â  Â  position: absolute; /* ä½ç½®ã‚’ç´°ã‹ãèª¿æ•´ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ */

Â  Â  left: 50%; /* è¦ªè¦ç´ (damageEffectContainer)ã®çœŸã‚“ä¸­ã‚’åŸºæº–ã« */

Â  Â  font-size: 1.8em; /* æ–‡å­—ã®å¤§ãã• */

Â  Â  font-weight: bold; /* å¤ªå­—ã«ã™ã‚‹ */

Â  Â  color: #f00; /* ãƒ€ãƒ¡ãƒ¼ã‚¸è‰² (èµ¤) */

Â  Â  text-shadow: 1px 1px 1px rgba(255,255,255,0.7); /* ç™½ã„ç¸å–ã‚Šã‚’ã¤ã‘ã¦è¦‹ã‚„ã™ãã™ã‚‹ */

Â  Â  animation: damageFadeUp 0.8s ease-out forwards; /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­å®š */

Â  Â  white-space: nowrap; /* æ•°å­—ãŒé€”ä¸­ã§æ”¹è¡Œã—ãªã„ã‚ˆã†ã«ã™ã‚‹ */

Â  Â  transform: translateX(-50%); /* è¦ç´ è‡ªä½“ã®ä¸­å¿ƒã«ä½ç½®ã‚’åˆã‚ã›ã‚‹ */

Â  Â  user-select: none; /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã§ããªã„ã‚ˆã†ã« */

}

/* Critical Hitã®æ™‚ã®ç‰¹åˆ¥ãªã‚¹ã‚¿ã‚¤ãƒ« */

.damage-popup.critical-damage {

Â  Â  color: #ffeb3b; /* Critical Hitæ™‚ã®è‰² (é»„è‰²) */

Â  Â  font-size: 2.4em; /* é€šå¸¸ã‚ˆã‚Šå°‘ã—å¤§ãã */

Â  Â  font-weight: 900; /* ã•ã‚‰ã«å¤ªã */

Â  Â  text-shadow: 1px 1px 2px rgba(0,0,0,0.8); /* é»’ã„å½±ã§å¼·èª¿ */

}



/* ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒä¸Šã«æ¶ˆãˆã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š */

@keyframes damageFadeUp {

Â  Â  0% { /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ */

Â  Â  Â  Â  opacity: 1; /* å®Œå…¨ã«è¦‹ãˆã‚‹ */

Â  Â  Â  Â  transform: translate(-50%, 0); /* å…ƒã®ä½ç½® */

Â  Â  }

Â  Â  100% { /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ */

Â  Â  Â  Â  opacity: 0; /* å®Œå…¨ã«è¦‹ãˆãªããªã‚‹ */

Â  Â  Â  Â  transform: translate(-50%, -50px); /* ä¸Šã«50pxç§»å‹• */

Â  Â  }

}

Â  Â  Â  Â Â 

Â  Â  Â  Â  /* --- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– --- */

Â  Â  Â  Â  @media (max-width: 600px) {

Â  Â  Â  Â  Â  Â  Â h1 { font-size: 1.6em; }

Â  Â  Â  Â  Â  Â  Â .character-display { font-size: 2.5em; }

Â  Â  Â  Â  Â  Â  Â #question, #trainingQuestion { font-size: 1.8em; }

Â  Â  Â  Â  Â  Â  Â .choice-btn { font-size: 1.1em; padding: 8px 15px; min-width: 60px; }

Â  Â  Â  Â  Â  Â  Â #startBtn { font-size: 1em; padding: 10px 25px; min-width: 140px; }

Â  Â  Â  Â  Â  Â  Â #battleLog { font-size: 1em; }

Â  Â  Â  Â  Â  Â  Â #feedbackDisplay { font-size: 2.5em; padding: 8px 20px;}

Â  Â  Â  Â  Â  Â  Â #comboDisplay { font-size: 2em; top: 55%; }

Â  Â  Â  Â  Â  Â  Â #bgmToggleBtn { font-size: 1.5em; top: 10px; right: 10px; }

Â  Â  Â  Â  Â  Â  Â .mode-btn, .start-method-btn, .training-type-btn { font-size: 1.1em; padding: 10px 25px; min-width: 180px; }

Â  Â  Â  Â  Â  Â  Â .result-btn { font-size: 1em; padding: 10px 20px; min-width: 130px; }

Â  Â  Â  Â  Â  Â  Â #trainingStatus { font-size: 1.2em;}

Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- ãƒœã‚¹æ’ƒç ´æ¼”å‡ºã®è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« --- */

#bossDefeatedOverlay.show {

Â  Â  display: flex; /* display:none ã‹ã‚‰ flex ã«å¤‰ãˆã¦è¡¨ç¤º */

Â  Â  opacity: 1;Â  Â  /* é€æ˜ã‹ã‚‰å®Œå…¨è¡¨ç¤ºã« */

}

/* .show ã‚¯ãƒ©ã‚¹ãŒä»˜ã„ãŸã¨ãã«ã€ä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã•ã›ã‚‹ */

#bossDefeatedOverlay.show #bossDefeatedMessage {

Â  Â  opacity: 1;Â  Â  /* é€æ˜ã‹ã‚‰å®Œå…¨è¡¨ç¤ºã« */

Â  Â  transform: scale(1); /* å°‘ã—æ‹¡å¤§ã—ãªãŒã‚‰è¡¨ç¤ºã•ã‚Œã‚‹æ„Ÿã˜ */

}

Â  Â  </style>

</head>

<body>

Â  Â  <h1>ã­ã“ãƒãƒˆãƒ«ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h1>

Â  Â  <button id="bgmToggleBtn">ğŸ”Š</button>



Â  Â  <div id="modeSelectScreen" class="screen">

Â  Â  Â  Â  <h2>ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­ï¼</h2>

Â  Â  Â  Â  <button id="grade1ModeBtn" class="mode-btn">ğŸ’ ï¼‘ã­ã‚“ã›ã„</button>

Â  Â  Â  Â  <button id="grade2ModeBtn" class="mode-btn">ğŸ’ ï¼’ã­ã‚“ã›ã„</button>

Â  Â  Â  Â  <button id="grade3ModeBtn" class="mode-btn">ğŸ“š ï¼“ã­ã‚“ã›ã„</button>

Â  Â  Â  Â  <button id="grade4ModeBtn" class="mode-btn">ğŸ“š ï¼”ã­ã‚“ã›ã„</button>

Â  Â  Â  Â  <button id="grade5ModeBtn" class="mode-btn">ğŸ“ ï¼•ã­ã‚“ã›ã„</button>

Â  Â  Â  Â  <button id="trainingModeBtn" class="mode-btn">ğŸ’ª ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</button>

Â  Â  </div>



Â  Â  <div id="startMethodScreen" class="screen">

Â  Â  Â  Â  <h2>ã©ã†ã‚„ã£ã¦ã¯ã˜ã‚ã‚‹ï¼Ÿ</h2>

Â  Â  Â  Â  <button id="startFromBeginningBtn" class="start-method-btn">ã¯ã˜ã‚ã‹ã‚‰ (Lv 1)</button>

Â  Â  Â  Â  <button id="continueFromLastBtn" class="start-method-btn" style="display: none;">ã¤ã¥ãã‹ã‚‰ (Lv X)</button>

Â  Â  </div>



Â  Â  <div id="battleScreen" class="screen">

Â  Â  Â  Â  <div id="enemyArea" class="character-area"> <div class="character-info"> <span class="character-name" id="enemyName"></span> <span class="character-hp-text">HP: <span id="enemyHPText"></span></span> </div> <div class="hp-bar-container"> <div class="hp-bar" id="enemyHPBar"></div> </div> <div class="character-display" id="enemyCharacter"></div><div id="damageEffectContainer" style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); pointer-events: none; z-index: 5; height: 50px; width: 100px;"></div> </div>

Â  Â  Â  Â  <div id="questionArea"> <div id="question"></div> <div id="answerChoices"></div> </div>

Â  Â  Â  Â  <div id="playerArea" class="character-area"> <div class="character-display" id="playerCharacter">ğŸ˜º</div> <div class="hp-bar-container"> <div class="hp-bar" id="playerHPBar"></div> </div> <div class="character-info"> <span class="character-name">ã«ã‚ƒã‚“ãŸã‚ã†</span> <span class="character-hp-text">HP: <span id="playerHPText"></span></span> </div> </div>

Â  Â  Â  Â  <div id="infoArea"> <div id="battleLog"></div> <button id="startBtn"></button> </div>

Â  Â  </div>



Â  Â  <div id="trainingTypeSelectScreen" class="screen">

Â  Â  Â  Â  <h2>ã‚Œã‚“ã—ã‚…ã†ã™ã‚‹ ãªã„ã‚ˆã† ã‚’ ãˆã‚‰ã‚“ã§ã­ï¼</h2>

Â  Â  Â  Â  <button class="training-type-btn" data-training-type="addsub1">ã‹ã‚“ãŸã‚“ ãŸã—ç®—ãƒ»ã²ãç®—</button>

Â  Â  Â  Â  <button class="training-type-btn" data-training-type="addsub2">ãµã¤ã† ãŸã—ç®—ãƒ»ã²ãç®—</button>

Â  Â  Â  Â  <button class="training-type-btn" data-training-type="mul">ã‹ã‘ç®— (ä¹ä¹ãƒã‚¹ã‚¿ãƒ¼)</button>

Â  Â  Â  Â  <button class="training-type-btn" data-training-type="div">ã‚ã‚Šç®— (ã‚ã¾ã‚Šãªã—)</button>

Â  Â  Â  Â  <button id="backToModeSelectBtn">ã‚‚ã©ã‚‹</button>

Â  Â  </div>



Â  Â  <div id="trainingScreen" class="screen">

Â  Â  Â  Â  <div id="trainingStatus"> <span id="trainingTimer">ã®ã“ã‚Šæ™‚é–“: 60ç§’</span> <span id="trainingScore">ãŸãŠã—ãŸæ•°: 0</span> </div>

Â  Â  Â  Â  <div id="trainingEnemyDisplay">ğŸ’§</div>

Â  Â  Â  Â  <div id="trainingQuestion"></div>

Â  Â  Â  Â  <div id="trainingAnswerChoices"></div>

Â  Â  </div>



Â  Â  <div id="trainingResultScreen" class="screen">

Â  Â  Â  Â  <h2>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° ãŠã‚ã‚Šï¼</h2>

Â  Â  Â  Â  <div>ã‘ã£ã‹ ã¯ã£ã´ã‚‡ã†ï¼</div>

Â  Â  Â  Â  <div id="finalScore" style="margin: 15px 0;">0 ã²ã ãŸãŠã—ãŸï¼</div>

Â  Â  Â  Â  <div id="personalBest">ã˜ã“ãƒ™ã‚¹ãƒˆ: 0 ã²ã</div>

Â  Â  Â  Â  <div class="result-btn-area"> <button id="retryTrainingBtn" class="result-btn">ã‚‚ã†ä¸€å›ï¼</button> <button id="backToModeSelectBtnFromTraining" class="result-btn">ãƒ¢ãƒ¼ãƒ‰é¸æŠã¸</button> </div>

Â  Â  </div>



Â  Â  <div id="feedbackDisplay"></div>

Â  Â  <div id="comboDisplay"></div>



Â  Â  Â  Â  <div id="bossDefeatedOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); justify-content: center; align-items: center; z-index: 50; opacity: 0; transition: opacity 0.5s ease-in-out;">

Â  Â  Â  Â  <div id="bossDefeatedMessage" style="font-size: clamp(2em, 8vw, 4em); color: #ffd700; font-weight: bold; text-shadow: 3px 3px 5px rgba(0,0,0,0.8); text-align: center; transform: scale(0.5); opacity: 0; transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.3s ease-out;">

Â  Â  Â  Â  Â  Â  </div>

Â  Â  </div>



Â  <script>

Â  Â  // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ç­‰ ---

Â  Â  let currentStage = 1; let gameMode = ''; let playerMaxHP = 15; let playerHP = playerMaxHP;

Â  Â  let currentEnemy = {}; let enemyMaxHP = 10; let enemyHP = enemyMaxHP;

Â  Â  let problems = []; let currentProblemIndex = 0; let questionStartTime;

Â  Â  let battleInProgress = false; let comboCount = 0; let isBgmEnabled = true;

Â  Â  const BGM_KEY = 'nekobattle_bgmEnabled_v1'; let questionsForThisStage = 15;

Â  Â  const HIGHEST_STAGE_KEY_PREFIX = 'nekobattle_highestStage_'; let highestClearedStage = 0;

Â  Â  let trainingType = ''; let trainingTimeLimit = 60; let trainingTimeRemaining = trainingTimeLimit; let trainingScore = 0; let trainingTimerInterval = null; const BEST_SCORE_KEY_PREFIX = 'nekobattle_bestScore_'; let currentTrainingProblem = null;

let comboDisplayTimeoutId = null; // â˜…è¿½åŠ : ã‚³ãƒ³ãƒœè¡¨ç¤ºã‚’æ¶ˆã™ã‚¿ã‚¤ãƒãƒ¼IDç”¨

Â  Â  // --- DOMè¦ç´ å–å¾— ---

Â  Â  const modeSelectScreen = document.getElementById("modeSelectScreen"); const grade1ModeBtn = document.getElementById("grade1ModeBtn"); const grade2ModeBtn = document.getElementById("grade2ModeBtn"); const grade3ModeBtn = document.getElementById("grade3ModeBtn"); const grade4ModeBtn = document.getElementById("grade4ModeBtn"); const grade5ModeBtn = document.getElementById("grade5ModeBtn"); const trainingModeBtn = document.getElementById("trainingModeBtn"); const startMethodScreen = document.getElementById("startMethodScreen"); const startFromBeginningBtn = document.getElementById("startFromBeginningBtn"); const continueFromLastBtn = document.getElementById("continueFromLastBtn"); const battleScreen = document.getElementById("battleScreen"); const startBtn = document.getElementById("startBtn"); const questionDiv = document.getElementById("question"); const answerChoicesDiv = document.getElementById("answerChoices"); const battleLog = document.getElementById("battleLog"); const enemyArea = document.getElementById("enemyArea"); const enemyName = document.getElementById("enemyName"); const enemyHPText = document.getElementById("enemyHPText"); const enemyHPBar = document.getElementById("enemyHPBar"); const enemyCharacter = document.getElementById("enemyCharacter"); const playerArea = document.getElementById("playerArea"); const playerHPText = document.getElementById("playerHPText"); const playerHPBar = document.getElementById("playerHPBar"); const playerCharacter = document.getElementById("playerCharacter"); const feedbackDisplay = document.getElementById("feedbackDisplay"); const comboDisplay = document.getElementById("comboDisplay"); const bgmToggleBtn = document.getElementById("bgmToggleBtn");

Â  Â  Â  const damageEffectContainer = document.getElementById('damageEffectContainer'); // ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤ºç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠ

Â  Â  const trainingTypeSelectScreen = document.getElementById("trainingTypeSelectScreen"); const trainingScreen = document.getElementById("trainingScreen"); const trainingTimer = document.getElementById("trainingTimer"); const trainingScoreDisplay = document.getElementById("trainingScore"); const trainingEnemyDisplay = document.getElementById("trainingEnemyDisplay"); const trainingQuestion = document.getElementById("trainingQuestion"); const trainingAnswerChoices = document.getElementById("trainingAnswerChoices"); const trainingResultScreen = document.getElementById("trainingResultScreen"); const finalScore = document.getElementById("finalScore"); const personalBest = document.getElementById("personalBest"); const retryTrainingBtn = document.getElementById("retryTrainingBtn"); const backToModeSelectBtn = document.getElementById("backToModeSelectBtn"); const backToModeSelectBtnFromTraining = document.getElementById("backToModeSelectBtnFromTraining");



Â  Â  Â  Â  Â  const bossDefeatedOverlay = document.getElementById('bossDefeatedOverlay'); // ãƒœã‚¹æ’ƒç ´æ¼”å‡ºã®èƒŒæ™¯

Â  Â  const bossDefeatedMessage = document.getElementById('bossDefeatedMessage'); // ãƒœã‚¹æ’ƒç ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºéƒ¨åˆ†



Â  Â  // --- åŠ¹æœéŸ³ã¨BGM ---

const sounds = {

Â  Â  tap: new Audio('tap.mp3'),

Â  Â  // hitEnemy: new Audio('hit_enemy.mp3'), // ä½¿ã‚ãªã„ã®ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‹å‰Šé™¤

Â  Â  hitPlayer: new Audio('hit_player.mp3'), // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’å—ã‘ãŸæ™‚ã®éŸ³

Â  Â  wrong: new Audio('wrong.mp3'),Â  Â  Â  Â  Â  // ä¸æ­£è§£ã®éŸ³

Â  Â  enemyDefeated: new Audio('enemy_defeated.mp3'), // æ•µã‚’å€’ã—ãŸæ™‚ã®éŸ³

Â  Â  // criticalHit: new Audio('critical_hit.mp3'), // æ–°ã—ã„åå‰ã«ã™ã‚‹ã®ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‹å‰Šé™¤

Â  Â  bgmNormal: new Audio('bgm_normal.mp3'),

Â  Â  bgmBoss: new Audio('bgm_boss.mp3'),

Â  Â  bgmTraining: new Audio('bgm_training.mp3'),

Â  Â  // â–¼â–¼â–¼ æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«åã«åˆã‚ã›ã¦è¨­å®š â–¼â–¼â–¼

Â  Â  hitGood: new Audio('hit_normal.mp3'),Â  Â  Â  // Goodè©•ä¾¡ => hit_normal.mp3

Â  Â  hitGreat: new Audio('hit_normal.mp3'),Â  Â  Â // Greatè©•ä¾¡ => hit_normal.mp3 (Goodã¨åŒã˜)

Â  Â  hitPerfect: new Audio('hit_perfect.mp3'),Â  Â // Perfectè©•ä¾¡ => hit_perfect.mp3

Â  Â  hitCritical: new Audio('critical_hit.mp3'), // Criticalè©•ä¾¡ => critical_hit.mp3

Â  Â  comboMilestone: new Audio('combo_milestone.mp3') // ã‚³ãƒ³ãƒœé”æˆéŸ³ => combo_milestone.mp3

Â  Â  // â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²

};Â  Â  sounds.bgmNormal.loop = true; sounds.bgmBoss.loop = true; sounds.bgmTraining.loop = true;

Â  Â  sounds.bgmNormal.volume = 0.4; sounds.bgmBoss.volume = 0.35; sounds.bgmTraining.volume = 0.4; let currentBgm = null;

Â  Â  function playSound(soundName) { if (!sounds[soundName]) return; sounds[soundName].currentTime = 0; sounds[soundName].play().catch(error => console.log(`Sound play failed (${soundName}):`, error)); }

Â  Â  function playBgm(bgmName) { if (!isBgmEnabled || !sounds[bgmName]) return; stopBgm(); sounds[bgmName].play().catch(error => console.log(`BGM play failed (${bgmName}):`, error)); currentBgm = sounds[bgmName]; }

Â  Â  function stopBgm() { if (currentBgm) { currentBgm.pause(); currentBgm.currentTime = 0; currentBgm = null; } }

Â  Â  function updateBgmButton() { if (isBgmEnabled) { bgmToggleBtn.classList.remove('muted'); bgmToggleBtn.textContent = 'ğŸ”Š'; } else { bgmToggleBtn.classList.add('muted'); bgmToggleBtn.textContent = 'ğŸ”‡'; } }

Â  Â  function loadBgmSetting() { const savedSetting = localStorage.getItem(BGM_KEY); isBgmEnabled = (savedSetting !== null) ? JSON.parse(savedSetting) : true; updateBgmButton(); }

Â  Â  bgmToggleBtn.addEventListener('click', () => { isBgmEnabled = !isBgmEnabled; localStorage.setItem(BGM_KEY, JSON.stringify(isBgmEnabled)); updateBgmButton(); if (isBgmEnabled) { if (!currentBgm && (battleInProgress || gameMode === 'training')) { if(gameMode === 'training') playBgm('bgmTraining'); else if (currentEnemy && typeof currentEnemy.type !== 'undefined') playBgm(currentEnemy.type === 'boss' ? 'bgmBoss' : 'bgmNormal'); } } else { stopBgm(); } playSound('tap'); });



Â  Â  // --- æ•µãƒ‡ãƒ¼ã‚¿ Lv40ã¾ã§ ---

Â  Â  const enemies = { 1: { name: "ã·ã‚‹ã·ã‚‹ã‚¹ãƒ©ã‚¤ãƒ ", emoji: "ğŸ’§", hp: 10, type: "normal" }, 2: { name: "ã‚¹ãƒ©ã‚¤ãƒ ", emoji: "ğŸ’§", hp: 12, type: "normal" }, 3: { name: "ãŠãŠããªã‚¹ãƒ©ã‚¤ãƒ ", emoji: "ğŸ’§", hp: 15, type: "normal" }, 4: { name: "ã¶ãã¿ãªã‚³ã‚¦ãƒ¢ãƒª", emoji: "ğŸ¦‡", hp: 18, type: "normal" }, 5: { name: "ãƒœã‚¹ ã‚³ã‚¦ãƒ¢ãƒªãƒ­ãƒ¼ãƒ‰", emoji: "ğŸ¦‡ğŸ‘‘", hp: 28, type: "boss" }, 6: { name: "ã•ã¾ã‚ˆã†ã‚´ãƒ¼ã‚¹ãƒˆ", emoji: "ğŸ‘»", hp: 22, type: "normal" }, 7: { name: "ã‚´ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ•", emoji: "ğŸ‘»", hp: 26, type: "normal" }, 8: { name: "ãƒ›ãƒãƒ›ãƒã‚¹ã‚±ãƒ«ãƒˆãƒ³", emoji: "ğŸ’€", hp: 30, type: "normal" }, 9: { name: "ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãƒŠã‚¤ãƒˆ", emoji: "ğŸ’€", hp: 35, type: "normal" }, 10: { name: "ãƒœã‚¹ ã‚´ãƒ–ãƒªãƒ³ã‚·ãƒ£ãƒ¼ãƒãƒ³", emoji: "ğŸ‘ºâœ¨", hp: 50, type: "boss" }, 11: { name: "ãã•ã£ãŸã—ãŸã„", emoji: "ğŸ§Ÿ", hp: 40, type: "normal" }, 12: { name: "ãƒãƒƒãƒ‰ãƒãƒ³ãƒ‰", emoji: "âœ‹", hp: 44, type: "normal" }, 13: { name: "ãƒãƒƒãƒ‰ãƒãƒ³ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼", emoji: "âœ‹", hp: 49, type: "normal" }, 14: { name: "ã‚¬ãƒ¼ã‚´ã‚¤ãƒ«", emoji: "ğŸ—¿ğŸ¦‡", hp: 55, type: "normal" }, 15: { name: "ãƒœã‚¹ ã‚µã‚¤ã‚¯ãƒ­ãƒ—ã‚¹", emoji: "ğŸ‘ï¸", hp: 75, type: "boss" }, 16: { name: "ã‚ªãƒ¼ã‚¯", emoji: "ğŸ—", hp: 65, type: "normal" }, 17: { name: "ã‚ªãƒ¼ã‚¯ãƒªãƒ¼ãƒ€ãƒ¼", emoji: "ğŸ—", hp: 72, type: "normal" }, 18: { name: "ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹", emoji: "ğŸ‚", hp: 80, type: "normal" }, 19: { name: "ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹ï¼ˆå…„ï¼‰", emoji: "ğŸ‚", hp: 88, type: "normal" }, 20: { name: "ãƒœã‚¹ ãƒªãƒƒãƒ", emoji: "ğŸ’€ğŸ‘‘", hp: 115, type: "boss" }, 21: { name: "ã‚¢ã‚¤ã‚¹ã‚´ãƒ¼ãƒ¬ãƒ ", emoji: "ğŸ§ŠğŸ—¿", hp: 100, type: "normal" }, 22: { name: "ãƒ•ãƒ¬ã‚¤ãƒ ã‚´ãƒ¼ãƒ¬ãƒ ", emoji: "ğŸ”¥ğŸ—¿", hp: 100, type: "normal" }, 23: { name: "ã‚­ãƒ¡ãƒ©", emoji: "ğŸ¦ğŸğŸ", hp: 115, type: "normal" }, 24: { name: "ã‚­ãƒ¡ãƒ©ï¼ˆå¤‰ç•°ç¨®ï¼‰", emoji: "ğŸ¦ğŸğŸ", hp: 125, type: "normal" }, 25: { name: "ãƒœã‚¹ ã‚°ãƒªãƒ•ã‚©ãƒ³", emoji: "ğŸ¦…ğŸ¦", hp: 160, type: "boss" }, 26: { name: "ãƒ¬ãƒƒã‚µãƒ¼ãƒ‡ãƒ¼ãƒ¢ãƒ³", emoji: "ğŸ‘¿", hp: 140, type: "normal" }, 27: { name: "ã‚¢ãƒ¼ã‚¯ãƒ‡ãƒ¼ãƒ¢ãƒ³", emoji: "ğŸ”¥ğŸ‘¿", hp: 155, type: "normal" }, 28: { name: "ãƒ€ãƒ¼ã‚¯ãƒŠã‚¤ãƒˆ", emoji: "ğŸ›¡ï¸âš”ï¸", hp: 170, type: "normal" }, 29: { name: "ãƒ‡ã‚¹ãƒŠã‚¤ãƒˆ", emoji: "ğŸ’€âš”ï¸", hp: 185, type: "normal" }, 30: { name: "ãƒœã‚¹ ãƒ‰ãƒ©ã‚´ãƒ³ã‚¾ãƒ³ãƒ“", emoji: "ğŸ’€ğŸ‰", hp: 230, type: "boss" }, 31: { name: "ãƒ¡ã‚¿ãƒ«ã‚¹ãƒ©ã‚¤ãƒ ", emoji: "âš™ï¸ğŸ’§", hp: 50, type: "normal" }, 32: { name: "ã¯ãã‚Œãƒ¡ã‚¿ãƒ«", emoji: "âœ¨ğŸ’§", hp: 70, type: "normal" }, 33: { name: "é­”ç•Œã®é¨å£«", emoji: "ğŸ˜ˆâš”ï¸", hp: 250, type: "normal" }, 34: { name: "é­”ç•Œã®é­”é“å£«", emoji: "ğŸ˜ˆğŸ§™", hp: 270, type: "normal" }, 35: { name: "ãƒœã‚¹ ãƒ’ãƒ‰ãƒ©", emoji: "ğŸğŸğŸ", hp: 340, type: "boss" }, 36: { name: "é­”ç‹ã®ã—ã‚‚ã¹ãƒ»ç‚", emoji: "ğŸ”¥ã—ã‚‚ã¹", hp: 300, type: "normal" }, 37: { name: "é­”ç‹ã®ã—ã‚‚ã¹ãƒ»æ°·", emoji: "ğŸ§Šã—ã‚‚ã¹", hp: 300, type: "normal" }, 38: { name: "é­”ç‹ã®ã—ã‚‚ã¹ãƒ»é›·", emoji: "âš¡ã—ã‚‚ã¹", hp: 300, type: "normal" }, 39: { name: "é­”ç‹è¦ªè¡›éšŠé•·", emoji: "ğŸ‘‘ğŸ›¡ï¸âš”ï¸", hp: 360, type: "normal" }, 40: { name: "å¤§é­”ç‹ãƒ‹ãƒ£ãƒ³ã‚¾ãƒ¼ãƒ", emoji: "ğŸ˜ˆğŸ‘‘ğŸˆ", hp: 480, type: "boss" } };

Â  Â  const maxStage = Object.keys(enemies).length;



Â  Â  // --- localStorageé–¢é€£ ---

Â  Â  function getHighestStageKey(mode) { return `${HIGHEST_STAGE_KEY_PREFIX}${mode}_v2`; }

Â  Â  function saveHighestStage(mode, stage) { const key = getHighestStageKey(mode); const currentHighest = loadHighestStage(mode); if (stage > currentHighest && stage <= maxStage) { localStorage.setItem(key, stage.toString()); } }

Â  Â  function loadHighestStage(mode) { const key = getHighestStageKey(mode); const savedStage = localStorage.getItem(key); return savedStage ? parseInt(savedStage, 10) : 0; }

Â  Â  function getBestScoreKey(type) { return `${BEST_SCORE_KEY_PREFIX}${type}`; }

Â  Â  function saveBestScore(type, score) { const key = getBestScoreKey(type); const currentBest = loadBestScore(type); if (score > currentBest) { localStorage.setItem(key, score.toString()); return true; } return false; }

Â  Â  function loadBestScore(type) { const key = getBestScoreKey(type); const savedScore = localStorage.getItem(key); return savedScore ? parseInt(savedScore, 10) : 0; }



Â  Â  // --- å•é¡Œç”Ÿæˆé–¢æ•° (5ãƒ¢ãƒ¼ãƒ‰, Lv40å¯¾å¿œ) ---

Â  Â  function generateProblems(stage, mode, count) {

Â  Â  Â  Â  const generatedProblems = [];

Â  Â  Â  Â  let num1, num2, num3, answer, questionText, type, correctAnswerValue;

Â  Â  Â  Â  for (let i = 0; i < count; i++) {

Â  Â  Â  Â  Â  Â  correctAnswerValue = null; questionText = ''; type = '';

Â  Â  Â  Â  Â  Â  let problemTypeRand = Math.random();

Â  Â  Â  Â  Â  Â  try {

Â  Â  Â  Â  Â  Â  Â  Â  Â if (mode === 'grade1') { if (stage <= 10) { type = '+'; do { num1 = Math.floor(Math.random() * 10); num2 = Math.floor(Math.random() * (10 - num1)); } while (num1 === 0 && num2 === 0); correctAnswerValue = num1 + num2; questionText = `${num1} + ${num2}`; } else if (stage <= 20) { type = '-'; num1 = Math.floor(Math.random() * 6) + 5; num2 = Math.floor(Math.random() * num1) + 1; correctAnswerValue = num1 - num2; questionText = `${num1} - ${num2}`; } else if (stage <= 30) { type = '+'; num1 = Math.floor(Math.random() * 9) + 1; num2 = Math.floor(Math.random() * 9) + 1; correctAnswerValue = num1 + num2; questionText = `${num1} + ${num2}`; } else { type = '+'; num2 = Math.floor(Math.random() * 8) + 1; correctAnswerValue = Math.floor(Math.random() * 8) + 1; num1 = correctAnswerValue + num2; if(num1 > 15) {num1=15; correctAnswerValue = num1-num2; if(correctAnswerValue<0) correctAnswerValue=0;}; questionText = `? + ${num2} = ${num1}`; } }

Â  Â  Â  Â  Â  Â  Â  Â  Â else if (mode === 'grade2') { if (stage <= 10) { if(problemTypeRand < 0.5) { type = '+'; num1 = Math.floor(Math.random() * 9) + 1; num2 = Math.floor(Math.random() * 9) + 1; correctAnswerValue = num1 + num2; questionText = `${num1} + ${num2}`; } else { type = '-'; num1 = Math.floor(Math.random() * 10) + 10; num2 = Math.floor(Math.random() * 9) + 1; correctAnswerValue = num1 - num2; questionText = `${num1} - ${num2}`; } } else if (stage <= 20) { type = 'Ã—'; num1 = Math.floor(Math.random() * 4) + 2; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`; } else if (stage <= 30) { type = 'Ã—'; num1 = Math.floor(Math.random() * 8) + 2; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`; } else { if (Math.random() < 0.5) { type = '+'; num1 = Math.floor(Math.random() * 9) + 1; correctAnswerValue = Math.floor(Math.random() * 9) + 1; num2 = num1 + correctAnswerValue; questionText = `${num1} + ? = ${num2}`; } else { type = '-'; num1 = Math.floor(Math.random() * 10) + 10; correctAnswerValue = Math.floor(Math.random() * 8) + 1; num2 = num1 - correctAnswerValue; questionText = `${num1} - ? = ${num2}`; } } }

Â  Â  Â  Â  Â  Â  Â  Â  Â else if (mode === 'grade3') { if (stage <= 10) { if(problemTypeRand < 0.6) { type = 'Ã—'; num1 = Math.floor(Math.random() * 8) + 2; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`; } else { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 8) + 2; num1 = num2 * correctAnswerValue; questionText = `${num1} Ã· ${num2}`; } } else if (stage <= 20) { if(problemTypeRand < 0.6) { type = 'Ã—'; num1 = Math.floor(Math.random()*6)+10; num2 = Math.floor(Math.random()*8)+2; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`; } else { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 8) + 2; num1 = num2 * correctAnswerValue; questionText = `${num1} Ã· ${num2}`; } } else if (stage <= 30) { if(problemTypeRand < 0.5) { type = '+'; num1 = Math.floor(Math.random()*80)+10; num2 = Math.floor(Math.random()*80)+10; correctAnswerValue = num1 + num2; questionText = `${num1} + ${num2}`; } else { type = '-'; num1 = Math.floor(Math.random()*80)+10; num2 = Math.floor(Math.random()*num1)+10; correctAnswerValue = num1 - num2; questionText = `${num1} - ${num2}`; } } else { if (Math.random() < 0.5) { type = 'Ã—'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 8) + 2; num1 = num2 * correctAnswerValue; if (Math.random() < 0.5) { questionText = `? Ã— ${num2} = ${num1}`; } else { questionText = `${correctAnswerValue} Ã— ? = ${num1}`; correctAnswerValue = num2; } } else { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; num3 = Math.floor(Math.random() * 8) + 2; num1 = num2 * num3; if (Math.random() < 0.5) { questionText = `${num1} Ã· ? = ${num3}`; correctAnswerValue = num2; } else { questionText = `? Ã· ${num2} = ${num3}`; correctAnswerValue = num1; } } } }

Â  Â  Â  Â  Â  Â  Â  Â  Â else if (mode === 'grade4') { if (stage <= 5) { if(problemTypeRand < 0.5) { type = 'Ã—'; num1 = Math.floor(Math.random() * 8) + 2; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`; } else { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 8) + 2; num1 = num2 * correctAnswerValue; questionText = `${num1} Ã· ${num2}`; } } else if (stage <= 15) { if(problemTypeRand < 0.5) { if (Math.random() < 0.5) { type = '+'; num1 = Math.floor(Math.random() * 80) + 10; num2 = Math.floor(Math.random() * 80) + 10; correctAnswerValue = num1 + num2; questionText = `${num1} + ${num2}`; } else { type = '-'; num1 = Math.floor(Math.random() * 80) + 20; num2 = Math.floor(Math.random() * (num1-10)) + 10; correctAnswerValue = num1 - num2; questionText = `${num1} - ${num2}`; } } else if (problemTypeRand < 0.8) { type = 'Ã—'; num1 = Math.floor(Math.random() * 8) + 2; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`; } else { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 8) + 2; num1 = num2 * correctAnswerValue; questionText = `${num1} Ã· ${num2}`; } } else if (stage <= 30) { if(problemTypeRand < 0.6) { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 20) + 5; num1 = num2 * correctAnswerValue; questionText = `${num1} Ã· ${num2}`; } else { type = 'Ã—'; num1 = Math.floor(Math.random()*10)+10; num2 = Math.floor(Math.random()*8)+2; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`; } } else { if (Math.random() < 0.5) { type = 'Ã—'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 8) + 2; num1 = num2 * correctAnswerValue; if (Math.random() < 0.5) { questionText = `? Ã— ${num2} = ${num1}`; } else { questionText = `${correctAnswerValue} Ã— ? = ${num1}`; correctAnswerValue = num2; } } else { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; num3 = Math.floor(Math.random() * 8) + 2; num1 = num2 * num3; if (Math.random() < 0.5) { questionText = `${num1} Ã· ? = ${num3}`; correctAnswerValue = num2; } else { questionText = `? Ã· ${num2} = ${num3}`; correctAnswerValue = num1; } } } }

Â  Â  Â  Â  Â  Â  Â  Â  Â else { /* mode === 'grade5' */ if (stage <= 10) { if(problemTypeRand < 0.5) { if (Math.random() < 0.5) { type = '+'; num1 = Math.floor(Math.random() * 80) + 10; num2 = Math.floor(Math.random() * 80) + 10; correctAnswerValue = num1 + num2; questionText = `${num1} + ${num2}`; } else { type = '-'; num1 = Math.floor(Math.random() * 80) + 20; num2 = Math.floor(Math.random() * (num1-10)) + 10; correctAnswerValue = num1 - num2; questionText = `${num1} - ${num2}`; } } else if (problemTypeRand < 0.8) { type = 'Ã—'; num1 = Math.floor(Math.random() * 8) + 2; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`; } else { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 8) + 2; num1 = num2 * correctAnswerValue; questionText = `${num1} Ã· ${num2}`; } } else if (stage <= 20) { if(problemTypeRand < 0.5) { type = 'Ã—'; num1 = Math.floor(Math.random()*11)+10; num2 = Math.floor(Math.random()*8)+2; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`; } else { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 30) + 10; num1 = num2 * correctAnswerValue; questionText = `${num1} Ã· ${num2}`; } } else if (stage <= 30) { if(problemTypeRand < 0.5) { type = 'Ã—'; num1 = Math.floor(Math.random()*21)+10; num2 = Math.floor(Math.random()*9)+11; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`; } else if (problemTypeRand < 0.8) { type = '+'; num1 = Math.floor(Math.random()*800)+100; num2 = Math.floor(Math.random()*800)+100; correctAnswerValue = num1 + num2; questionText = `${num1} + ${num2}`; } else { type = '-'; num1 = Math.floor(Math.random()*800)+100; num2 = Math.floor(Math.random()*num1)+1; correctAnswerValue = num1 - num2; questionText = `${num1} - ${num2}`; } } else { const rand = Math.random(); if (rand < 0.6) { if (Math.random() < 0.5) { type = 'Ã—'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 12) + 2; num1 = num2 * correctAnswerValue; if (Math.random() < 0.5) { questionText = `? Ã— ${num2} = ${num1}`; } else { questionText = `${correctAnswerValue} Ã— ? = ${num1}`; correctAnswerValue = num2; } } else { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; num3 = Math.floor(Math.random() * 12) + 2; num1 = num2 * num3; if (Math.random() < 0.5) { questionText = `${num1} Ã· ? = ${num3}`; correctAnswerValue = num2; } else { questionText = `? Ã· ${num2} = ${num3}`; correctAnswerValue = num1; } } } else { type = 'Ã—'; num1 = Math.floor(Math.random()*40)+11; num2 = Math.floor(Math.random()*40)+11; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`; } } }

Â  Â  Â  Â  Â  Â  Â  Â  Â if (questionText && correctAnswerValue !== null) { generatedProblems.push({ q: questionText, a: correctAnswerValue }); } else { console.error("ERROR: Failed!", {stage, mode, i, type, num1, num2, num3, questionText, correctAnswerValue}); generatedProblems.push({ q: "1 + 1", a: 2 }); }

Â  Â  Â  Â  Â  Â  } catch (error) { console.error("ERROR during gen:", {stage, mode, i, error}); generatedProblems.push({ q: "2 + 2", a: 4 }); }

Â  Â  Â  Â  }

Â  Â  Â  Â  for (let i = generatedProblems.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [generatedProblems[i], generatedProblems[j]] = [generatedProblems[j], generatedProblems[i]]; }

Â  Â  Â  Â  return generatedProblems;

Â  Â  }



Â  Â  // --- é¸æŠè‚¢ç”Ÿæˆé–¢æ•° ---

Â  Â  function generateChoices(correct) { const choices = new Set(); if (typeof correct !== 'number' || isNaN(correct)) { console.error("Invalid 'correct' answer:", correct); correct = 0; } correct = Math.round(correct); choices.add(correct); const maxAttempts = 50; let attempts = 0; while (choices.size < 6 && attempts < maxAttempts) { let wrongAnswer; const magnitude = Math.max(1, Math.abs(correct)); const range = Math.min(10, Math.ceil(magnitude * 0.4) + 4); let delta = Math.floor(Math.random() * (range * 2 + 1)) - range; if (Math.random() < 0.15) { delta += (Math.random() < 0.5 ? 1 : -1) * (Math.floor(Math.random() * 10) + 5); } if (delta === 0) delta = Math.random() < 0.5 ? 1 : -1; wrongAnswer = correct + delta; wrongAnswer = Math.round(wrongAnswer); if (wrongAnswer >= 0 && !choices.has(wrongAnswer)) { choices.add(wrongAnswer); } attempts++; } let filler = 1; while (choices.size < 6) { let fillChoice1 = Math.max(0, correct + filler); let fillChoice2 = Math.max(0, correct - filler); if (!choices.has(fillChoice1)) choices.add(fillChoice1); if (choices.size < 6 && fillChoice2 >= 0 && !choices.has(fillChoice2)) choices.add(fillChoice2); filler++; if (filler > correct + 20) break; } const choiceArray = Array.from(choices); choiceArray.sort(() => Math.random() - 0.5); return choiceArray; }

Â  Â  // --- HPãƒãƒ¼æ›´æ–°é–¢æ•° ---

Â  Â  function updateHPBar(elementId, currentHP, maxHP) { const bar = document.getElementById(elementId); const percentage = Math.max(0, (currentHP / maxHP) * 100); bar.style.width = `${percentage}%`; }

Â  Â  // --- ã‚­ãƒ£ãƒ©æºã‚Œé–¢æ•° ---

Â  Â  function shakeCharacter(elementId) { const characterElement = document.getElementById(elementId); characterElement.classList.add('shake-animation'); setTimeout(() => { characterElement.classList.remove('shake-animation'); }, 200); }

Â  Â  // --- æ™‚é–“è©•ä¾¡è¡¨ç¤ºé–¢æ•° ---

Â  Â  function showFeedback(text, type) { feedbackDisplay.textContent = text; feedbackDisplay.className = 'show ' + type; setTimeout(() => { feedbackDisplay.className = ''; }, 800); }

// --- ã‚³ãƒ³ãƒœè¡¨ç¤ºæ›´æ–°é–¢æ•° --- (ã“ã“ã‹ã‚‰ã‚³ãƒ”ãƒ¼ãƒ»è‡ªå‹•æ¶ˆå»ç‰ˆ)

function updateComboDisplay() {

Â  Â  // â˜… æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ã‚¯ãƒªã‚¢ (é€£ç¶šã§ã‚³ãƒ³ãƒœã—ãŸæ™‚ã«å‰ã®ã‚¿ã‚¤ãƒãƒ¼ãŒæ®‹ã‚‰ãªã„ã‚ˆã†ã«)

Â  Â  if (comboDisplayTimeoutId) {

Â  Â  Â  Â  clearTimeout(comboDisplayTimeoutId);

Â  Â  Â  Â  comboDisplayTimeoutId = null;

Â  Â  }



Â  Â  if (comboCount >= 3) { // ã‚³ãƒ³ãƒœãŒ3ä»¥ä¸Šãªã‚‰è¡¨ç¤ºå‡¦ç†

Â  Â  Â  Â  comboDisplay.textContent = `${comboCount} Combo!`;

Â  Â  Â  Â  comboDisplay.classList.remove('great-combo', 'amazing-combo'); // è‰²ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ

Â  Â  Â  Â  if (comboCount >= 10) {

Â  Â  Â  Â  Â  Â  comboDisplay.classList.add('amazing-combo');

Â  Â  Â  Â  } else if (comboCount >= 5) {

Â  Â  Â  Â  Â  Â  comboDisplay.classList.add('great-combo');

Â  Â  Â  Â  }

Â  Â  Â  Â  comboDisplay.classList.add('show'); // è¡¨ç¤ºã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 



Â  Â  Â  Â  // â˜… è‡ªå‹•ã§æ¶ˆã™ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®š (1.5ç§’å¾Œã« 'show' ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤)

Â  Â  Â  Â  comboDisplayTimeoutId = setTimeout(() => {

Â  Â  Â  Â  Â  Â  comboDisplay.classList.remove('show');

Â  Â  Â  Â  Â  Â  comboDisplayTimeoutId = null; // ã‚¿ã‚¤ãƒãƒ¼IDã‚’ãƒªã‚»ãƒƒãƒˆ

Â  Â  Â  Â  Â  Â  // console.log("Combo display hidden by timeout"); // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°(å¿…è¦ãªã‚‰)

Â  Â  Â  Â  }, 1500); // 1500ãƒŸãƒªç§’ = 1.5ç§’ (ã“ã®æ™‚é–“ã¯èª¿æ•´å¯èƒ½ã§ã™)



Â  Â  } else { // ã‚³ãƒ³ãƒœãŒ3æœªæº€ãªã‚‰éè¡¨ç¤º

Â  Â  Â  Â  comboDisplay.classList.remove('show'); // è¡¨ç¤ºã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ (ã‚¿ã‚¤ãƒãƒ¼ã¯æ—¢ã«ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„)

Â  Â  }

}

// --- ã‚³ãƒ³ãƒœè¡¨ç¤ºæ›´æ–°é–¢æ•° --- (ã“ã“ã¾ã§ã‚³ãƒ”ãƒ¼)Â  Â  // --- showQuestioné–¢æ•° ---

Â  Â  function showQuestion() { battleInProgress = false; if (currentProblemIndex >= questionsForThisStage || playerHP <= 0 || enemyHP <= 0) { endBattle(); return; } if (!problems || problems.length <= currentProblemIndex) { console.error("Error: problems array invalid.", problems, currentProblemIndex); battleLog.textContent = "ã‚¨ãƒ©ãƒ¼ï¼šå•é¡Œæº–å‚™ã‚¨ãƒ©ãƒ¼"; endBattle(); return; } const p = problems[currentProblemIndex]; if (!p || typeof p.q === 'undefined' || typeof p.a === 'undefined') { console.error("Error: Invalid problem data.", p); battleLog.textContent = "ã‚¨ãƒ©ãƒ¼ï¼šå•é¡Œãƒ‡ãƒ¼ã‚¿ä¸æ­£"; endBattle(); return; } questionDiv.textContent = p.q; questionStartTime = Date.now(); battleLog.textContent = `Lv${currentStage} (${currentProblemIndex + 1}/${questionsForThisStage}) å•é¡Œï¼`; const choices = generateChoices(p.a); answerChoicesDiv.innerHTML = ""; if (Array.isArray(choices)) { choices.forEach(choice => { const btn = document.createElement("button"); btn.textContent = choice; btn.className = "choice-btn"; btn.onclick = () => handleAnswer(choice); answerChoicesDiv.appendChild(btn); }); } else { console.error("Error: choices not an array.", choices); battleLog.textContent = "ã‚¨ãƒ©ãƒ¼ï¼šé¸æŠè‚¢ç”Ÿæˆå¤±æ•—"; endBattle(); } }

Â  Â  Â // --- ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤ºé–¢æ•° --- (ã“ã“ã‹ã‚‰ã‚³ãƒ”ãƒ¼)

function showDamageEffect(damage, isCritical) {

Â  Â  // è¡¨ç¤ºã™ã‚‹å ´æ‰€ãŒãªã‹ã£ãŸã‚Šã€ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒ0ä»¥ä¸‹ãªã‚‰ä½•ã‚‚ã—ãªã„

Â  Â  if (!damageEffectContainer || damage <= 0) return;



Â  Â  // ãƒ€ãƒ¡ãƒ¼ã‚¸é‡ã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã®æ–°ã—ã„æ–‡å­—è¦ç´ ã‚’ä½œã‚‹

Â  Â  const damageText = document.createElement('span');

Â  Â  damageText.textContent = `-${damage}`; // ä¾‹: "-10" ã®ã‚ˆã†ã«è¡¨ç¤º

Â  Â  damageText.className = 'damage-popup'; // CSSã§è¨­å®šã—ãŸè¦‹ãŸç›®ã‚’é©ç”¨



Â  Â  // ã‚‚ã—Critical Hitãªã‚‰ã€ç‰¹åˆ¥ãªè¦‹ãŸç›®ã‚‚è¿½åŠ ã™ã‚‹

Â  Â  if (isCritical) {

Â  Â  Â  Â  damageText.classList.add('critical-damage');

Â  Â  }



Â  Â  // ãƒ€ãƒ¡ãƒ¼ã‚¸æ•°å­—ãŒæ¯å›åŒã˜å ´æ‰€ã«å‡ºãªã„ã‚ˆã†ã«ã€å°‘ã—å·¦å³ã«ãšã‚‰ã™ï¼ˆãŠå¥½ã¿ã§ï¼‰

Â  Â  const randomOffsetX = Math.random() * 40 - 20; // æ¨ªã«-20pxã‹ã‚‰+20pxã®ç¯„å›²ã§ãšã‚‰ã™

Â  Â  // CSSã® left ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä½¿ã£ã¦ä½ç½®ã‚’èª¿æ•´

Â  Â  damageText.style.left = `calc(50% + ${randomOffsetX}px)`;



Â  Â  // ä½œã£ãŸãƒ€ãƒ¡ãƒ¼ã‚¸æ–‡å­—è¦ç´ ã‚’ã€HTMLã®å…¥ã‚Œç‰©(damageEffectContainer)ã®ä¸­ã«è¿½åŠ ã—ã¦è¡¨ç¤ºã™ã‚‹

Â  Â  damageEffectContainer.appendChild(damageText);



Â  Â  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒçµ‚ã‚ã‚‹é ƒï¼ˆ0.8ç§’å¾Œï¼‰ã«ã€è¡¨ç¤ºã—ãŸãƒ€ãƒ¡ãƒ¼ã‚¸æ–‡å­—è¦ç´ ã‚’æ¶ˆã™

Â  Â  setTimeout(() => {

Â  Â  Â  Â  // ã¾ã ç”»é¢ã«æ®‹ã£ã¦ã„ã‚Œã°å‰Šé™¤ã™ã‚‹ï¼ˆå¿µã®ãŸã‚ç¢ºèªï¼‰

Â  Â  Â  Â  if (damageText.parentNode === damageEffectContainer) {

Â  Â  Â  Â  Â  Â  Â damageEffectContainer.removeChild(damageText);

Â  Â  Â  Â  }

Â  Â  }, 800); // CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®æ™‚é–“ï¼ˆ0.8ç§’ = 800ãƒŸãƒªç§’ï¼‰ã«åˆã‚ã›ã‚‹

}

// --- ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤ºé–¢æ•° --- (ã“ã“ã¾ã§ã‚³ãƒ”ãƒ¼)



// --- handleAnsweré–¢æ•° --- (ã“ã“ã‹ã‚‰ã‚³ãƒ”ãƒ¼ãƒ»ã‚¿ã‚¤ãƒãƒ¼ã‚¯ãƒªã‚¢è¿½åŠ ç‰ˆ)

function handleAnswer(selectedAnswer) {

Â  Â  if (battleInProgress) return;

Â  Â  battleInProgress = true;

Â  Â  const choiceButtons = answerChoicesDiv.querySelectorAll('.choice-btn');

Â  Â  choiceButtons.forEach(btn => btn.disabled = true);

Â  Â  playSound('tap');

Â  Â  const elapsed = (Date.now() - questionStartTime) / 1000;

Â  Â  const p = problems[currentProblemIndex];

Â  Â  let feedbackClass = '';

Â  Â  let damageToEnemy = 0;

Â  Â  let damageToPlayer = 0;

Â  Â  let logMessage = "";

Â  Â  let feedbackText = "";

Â  Â  let feedbackType = "";

Â  Â  let isCritical = false;

Â  Â  let criticalTime, perfectTime, greatTime, goodTime, slowPenalty, wrongPenalty, baseDmgCrit, baseDmgPerf, baseDmgGreat, baseDmgGood;



Â  Â  // ãƒ¢ãƒ¼ãƒ‰ã”ã¨ã®è©•ä¾¡åŸºæº–ã¨ãƒ€ãƒ¡ãƒ¼ã‚¸è¨­å®š (ã“ã“ã¯å¤‰æ›´ãªã—)

Â  Â  switch (gameMode) {

Â  Â  Â  Â  case 'grade1': criticalTime = 3.0; perfectTime = 5.0; greatTime = 7.0; goodTime = 10.0; slowPenalty = 0; wrongPenalty = 1; baseDmgCrit = 6; baseDmgPerf = 4; baseDmgGreat = 2; baseDmgGood = 1; break;

Â  Â  Â  Â  case 'grade2': criticalTime = 2.0; perfectTime = 3.5; greatTime = 5.0; goodTime = 7.5; slowPenalty = 1; wrongPenalty = 1; baseDmgCrit = 6; baseDmgPerf = 4; baseDmgGreat = 2; baseDmgGood = 1; break;

Â  Â  Â  Â  case 'grade3': criticalTime = 1.5; perfectTime = 2.5; greatTime = 4.0; goodTime = 6.0; slowPenalty = 1; wrongPenalty = 2; baseDmgCrit = 5; baseDmgPerf = 3; baseDmgGreat = 2; baseDmgGood = 1; break;

Â  Â  Â  Â  case 'grade4': criticalTime = 1.5; perfectTime = 2.5; greatTime = 4.0; goodTime = 6.0; slowPenalty = 1; wrongPenalty = 2; baseDmgCrit = 5; baseDmgPerf = 3; baseDmgGreat = 2; baseDmgGood = 1; break;

Â  Â  Â  Â  case 'grade5': criticalTime = 1.5; perfectTime = 2.5; greatTime = 4.0; goodTime = 6.0; slowPenalty = 1; wrongPenalty = 2; baseDmgCrit = 5; baseDmgPerf = 3; baseDmgGreat = 2; baseDmgGood = 1; break;

Â  Â  Â  Â  default: criticalTime = 1.5; perfectTime = 2.5; greatTime = 4.0; goodTime = 6.0; slowPenalty = 1; wrongPenalty = 2; baseDmgCrit = 5; baseDmgPerf = 3; baseDmgGreat = 2; baseDmgGood = 1;

Â  Â  }



Â  Â  // æ­£è§£åˆ¤å®š

Â  Â  if (selectedAnswer === p.a) {

Â  Â  Â  Â  comboCount++;

Â  Â  Â  Â  let baseDamage = 0;



Â  Â  Â  Â  if (elapsed < criticalTime) {

Â  Â  Â  Â  Â  Â  baseDamage = baseDmgCrit; logMessage = `âœ¨Critical Hit!âœ¨ (${elapsed.toFixed(1)}ç§’) `; feedbackText = "Critical Hit!"; feedbackType = "critical"; isCritical = true;

Â  Â  Â  Â  } else if (elapsed < perfectTime) {

Â  Â  Â  Â  Â  Â  baseDamage = baseDmgPerf; logMessage = `Perfect! (${elapsed.toFixed(1)}ç§’) `; feedbackText = "Perfect!"; feedbackType = "perfect";

Â  Â  Â  Â  } else if (elapsed < greatTime) {

Â  Â  Â  Â  Â  Â  baseDamage = baseDmgGreat; logMessage = `Great! (${elapsed.toFixed(1)}ç§’) `; feedbackText = "Great!"; feedbackType = "great";

Â  Â  Â  Â  } else if (elapsed < goodTime) {

Â  Â  Â  Â  Â  Â  baseDamage = baseDmgGood; logMessage = `Good (${elapsed.toFixed(1)}ç§’) `; feedbackText = "Good"; feedbackType = "good";

Â  Â  Â  Â  } else { // æ™‚é–“ãŒã‹ã‹ã‚Šã™ããŸå ´åˆ

Â  Â  Â  Â  Â  Â  damageToPlayer = slowPenalty; logMessage = `Too slow... (${elapsed.toFixed(1)}ç§’) ${damageToPlayer > 0 ? `è‡ªåˆ†ã«${damageToPlayer}ãƒ€ãƒ¡ãƒ¼ã‚¸!` : 'ãƒ€ãƒ¡ãƒ¼ã‚¸ãªã—'}`; feedbackText = "Too Slow..."; feedbackType = "slow";

Â  Â  Â  Â  Â  Â  comboCount = 0; // ã‚³ãƒ³ãƒœãƒªã‚»ãƒƒãƒˆ

Â  Â  Â  Â  Â  Â  // â˜… ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ã‚¯ãƒªã‚¢

Â  Â  Â  Â  Â  Â  if (comboDisplayTimeoutId) {

Â  Â  Â  Â  Â  Â  Â  Â  clearTimeout(comboDisplayTimeoutId);

Â  Â  Â  Â  Â  Â  Â  Â  comboDisplayTimeoutId = null;

Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }



Â  Â  Â  Â  let comboBonus = 0;

Â  Â  Â  Â  if (comboCount >= 5) comboBonus = 2; else if (comboCount >= 3) comboBonus = 1;

Â  Â  Â  Â  damageToEnemy = baseDamage + comboBonus;



Â  Â  Â  Â  if (damageToEnemy > 0) {

Â  Â  Â  Â  Â  Â  logMessage += `æ•µã«${damageToEnemy}ãƒ€ãƒ¡ãƒ¼ã‚¸!`;

Â  Â  Â  Â  Â  Â  if (comboCount >= 3) logMessage += ` (${comboCount} Combo!)`;

Â  Â  Â  Â  Â  Â  feedbackClass = 'feedback-flash';

Â  Â  Â  Â  Â  Â  shakeCharacter('enemyCharacter');

Â  Â  Â  Â  Â  Â  if (isCritical) { playSound('hitCritical'); } else if (feedbackType === "perfect") { playSound('hitPerfect'); } else if (feedbackType === "great") { playSound('hitGreat'); } else if (feedbackType === "good") { playSound('hitGood'); }

Â  Â  Â  Â  Â  Â  showDamageEffect(damageToEnemy, isCritical);

Â  Â  Â  Â  Â  Â  if (comboCount === 5 || comboCount === 10 || comboCount === 15) { playSound('comboMilestone'); }

Â  Â  Â  Â  } else if (damageToPlayer > 0) { // Too slow ã§ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚ã‚Šã®å ´åˆ

Â  Â  Â  Â  Â  Â  feedbackClass = 'feedback-damage-player';

Â  Â  Â  Â  Â  Â  shakeCharacter('playerCharacter');

Â  Â  Â  Â  Â  Â  playSound('hitPlayer');

Â  Â  Â  Â  } else { // ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒç™ºç”Ÿã—ãªã„æ­£è§£ã®å ´åˆ

Â  Â  Â  Â  Â  Â  feedbackClass = 'feedback-correct';

Â  Â  Â  Â  }

Â  Â  } else { // ä¸æ­£è§£ã®å ´åˆ

Â  Â  Â  Â  playSound('wrong');

Â  Â  Â  Â  damageToPlayer = wrongPenalty;

Â  Â  Â  Â  logMessage = `Wrong! è‡ªåˆ†ã«${damageToPlayer}ãƒ€ãƒ¡ãƒ¼ã‚¸!`;

Â  Â  Â  Â  feedbackText = "Wrong!";

Â  Â  Â  Â  feedbackType = "wrong";

Â  Â  Â  Â  feedbackClass = 'feedback-wrong';

Â  Â  Â  Â  comboCount = 0; // ã‚³ãƒ³ãƒœãƒªã‚»ãƒƒãƒˆ

Â  Â  Â  Â  Â // â˜… ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ã‚¯ãƒªã‚¢

Â  Â  Â  Â  if (comboDisplayTimeoutId) {

Â  Â  Â  Â  Â  Â  clearTimeout(comboDisplayTimeoutId);

Â  Â  Â  Â  Â  Â  comboDisplayTimeoutId = null;

Â  Â  Â  Â  }

Â  Â  Â  Â  shakeCharacter('playerCharacter');

Â  Â  Â  Â  playSound('hitPlayer');

Â  Â  }



Â  Â  updateComboDisplay(); // ã‚³ãƒ³ãƒœè¡¨ç¤ºæ›´æ–° (ã“ã“ã§æ–°ã—ã„ã‚¿ã‚¤ãƒãƒ¼ãŒã‚»ãƒƒãƒˆã•ã‚Œã‚‹ or è¡¨ç¤ºãŒæ¶ˆãˆã‚‹)



Â  Â  enemyHP -= damageToEnemy;

Â  Â  playerHP -= damageToPlayer;

Â  Â  enemyHPText.textContent = Math.max(0, enemyHP);

Â  Â  playerHPText.textContent = Math.max(0, playerHP);

Â  Â  updateHPBar('enemyHPBar', enemyHP, enemyMaxHP);

Â  Â  updateHPBar('playerHPBar', playerHP, playerMaxHP);

Â  Â  battleLog.textContent = logMessage;

Â  Â  if(feedbackText) showFeedback(feedbackText, feedbackType);

Â  Â  if (feedbackClass) { document.body.classList.add(feedbackClass); setTimeout(() => { document.body.classList.remove(feedbackClass); }, 150); }



Â  Â  currentProblemIndex++;

Â  Â  setTimeout(() => {

Â  Â  Â  Â  if (playerHP <= 0 || enemyHP <= 0 || currentProblemIndex >= questionsForThisStage) {

Â  Â  Â  Â  Â  Â  endBattle();

Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  showQuestion();

Â  Â  Â  Â  }

Â  Â  }, 1000);

}

// --- handleAnsweré–¢æ•° --- (ã“ã“ã¾ã§ã‚³ãƒ”ãƒ¼)





Â  Â  Â  Â  Â  // --- startBattleé–¢æ•° ---

Â  Â  function startBattle() { currentEnemy = enemies[currentStage] || enemies[maxStage]; if (!currentEnemy) { console.error("Error: Cannot find enemy data for stage", currentStage); return; } enemyMaxHP = currentEnemy.hp; if (currentEnemy.type === 'boss') { enemyMaxHP = Math.floor(enemyMaxHP * 1.5); } let hpMultiplier = 1.0; switch (gameMode) { case 'grade1': hpMultiplier = 0.5; break; case 'grade2': hpMultiplier = 0.7; break; case 'grade3': hpMultiplier = 0.9; break; case 'grade4': hpMultiplier = 0.95; break; case 'grade5': hpMultiplier = 1.0; break; } enemyMaxHP = Math.max(5, Math.floor(enemyMaxHP * hpMultiplier)); enemyHP = enemyMaxHP; playerHP = playerMaxHP; currentProblemIndex = 0; comboCount = 0; updateComboDisplay(); questionsForThisStage = (currentEnemy.type === 'boss') ? 20 : 15; problems = generateProblems(currentStage, gameMode, questionsForThisStage); if (!problems || problems.length === 0) { console.error("Error: generateProblems returned empty!", {currentStage, gameMode, questionsForThisStage}); battleLog.textContent = "ã‚¨ãƒ©ãƒ¼ï¼šå•é¡Œç”Ÿæˆå¤±æ•—"; return; } enemyName.textContent = `${currentEnemy.emoji} ${currentEnemy.name} (Lv${currentStage})`; enemyHPText.textContent = enemyHP; playerHPText.textContent = playerHP; updateHPBar('enemyHPBar', enemyHP, enemyMaxHP); updateHPBar('playerHPBar', playerHP, playerMaxHP); enemyCharacter.textContent = currentEnemy.emoji; enemyCharacter.classList.remove('defeated'); stopBgm(); if (currentEnemy.type === 'boss') { document.body.classList.add('boss-battle-bg'); battleLog.textContent = `ğŸ”¥ãƒœã‚¹å‡ºç¾ï¼ ${currentEnemy.name} ãŒã‚ã‚‰ã‚ã‚ŒãŸï¼ğŸ”¥`; playBgm('bgmBoss'); } else { document.body.classList.remove('boss-battle-bg'); battleLog.textContent = `Lv${currentStage} ${currentEnemy.name} ãŒã‚ã‚‰ã‚ã‚ŒãŸï¼`; playBgm('bgmNormal'); } startBtn.style.display = "none"; battleInProgress = false; setTimeout(showQuestion, 1500); }



// --- endBattleé–¢æ•° --- (ã“ã“ã‹ã‚‰ã‚³ãƒ”ãƒ¼ãƒ»ã‚¿ã‚¤ãƒãƒ¼ã‚¯ãƒªã‚¢è¿½åŠ ç‰ˆ)

function endBattle() {

Â  Â  console.log("endBattle: é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ");

Â  Â  battleInProgress = true;

Â  Â  answerChoicesDiv.innerHTML = "";

Â  Â  questionDiv.textContent = "Battle End!";

Â  Â  comboDisplay.classList.remove('show'); // ã‚³ãƒ³ãƒœè¡¨ç¤ºã‚’æ¶ˆã™

Â  Â  // â˜… ã‚³ãƒ³ãƒœè¡¨ç¤ºã‚¿ã‚¤ãƒãƒ¼ãŒæ®‹ã£ã¦ã„ã‚Œã°ã‚¯ãƒªã‚¢

Â  Â  if (comboDisplayTimeoutId) {

Â  Â  Â  Â  clearTimeout(comboDisplayTimeoutId);

Â  Â  Â  Â  comboDisplayTimeoutId = null;

Â  Â  Â  Â  console.log("endBattle: Combo display timeout cleared on battle end."); // ãƒ­ã‚°è¿½åŠ 

Â  Â  }

Â  Â  stopBgm(); // BGMåœæ­¢



Â  Â  let resultMessage = "";

Â  Â  let nextButtonText = "";

Â  Â  let isVictory = false;



Â  Â  if (enemyHP <= 0) { // å‹åˆ©ã—ãŸå ´åˆ

Â  Â  Â  Â  console.log("endBattle: å‹åˆ©æ¡ä»¶ã‚’æº€ãŸã—ã¾ã—ãŸ (enemyHP <= 0)");

Â  Â  Â  Â  isVictory = true;

Â  Â  Â  Â  enemyCharacter.classList.add('defeated');



Â  Â  Â  Â  console.log("endBattle: æ•µã‚¿ã‚¤ãƒ—ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™:", currentEnemy.type);

Â  Â  Â  Â  if (currentEnemy.type === 'boss') {

Â  Â  Â  Â  Â  Â  console.log("endBattle: ãƒœã‚¹æ’ƒç ´ã¨åˆ¤å®šã•ã‚Œã¾ã—ãŸ");

Â  Â  Â  Â  Â  Â  playSound('enemyDefeated');



Â  Â  Â  Â  Â  Â  if (bossDefeatedMessage) { console.log("endBattle: bossDefeatedMessage ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®šã—ã¾ã™"); bossDefeatedMessage.textContent = `ğŸ‰ ãƒœã‚¹ ${currentEnemy.name} æ’ƒç ´ï¼ ğŸ‰`; } else { console.error("endBattle: bossDefeatedMessage ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼"); }

Â  Â  Â  Â  Â  Â  if (bossDefeatedOverlay) { console.log("endBattle: ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç›´æ¥å¤‰æ›´ã—ã¦è¡¨ç¤ºã—ã¾ã™"); bossDefeatedOverlay.style.display = 'flex'; bossDefeatedOverlay.style.opacity = '1'; if (bossDefeatedMessage) { bossDefeatedMessage.style.opacity = '1'; bossDefeatedMessage.style.transform = 'scale(1)'; } } else { console.error("endBattle: bossDefeatedOverlay ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼"); }



Â  Â  Â  Â  Â  Â  console.log("endBattle: 3ç§’å¾Œã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤ºã«ã™ã‚‹ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®šã—ã¾ã™");

Â  Â  Â  Â  Â  Â  setTimeout(() => {

Â  Â  Â  Â  Â  Â  Â  Â  console.log("endBattle: (3ç§’çµŒé) ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤éè¡¨ç¤ºå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™");

Â  Â  Â  Â  Â  Â  Â  Â  if (bossDefeatedOverlay) { bossDefeatedOverlay.style.opacity = '0'; if (bossDefeatedMessage) { bossDefeatedMessage.style.opacity = '0'; bossDefeatedMessage.style.transform = 'scale(0.5)'; } setTimeout(() => { console.log("endBattle: (ã•ã‚‰ã«0.5ç§’çµŒé) ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã® display ã‚’ none ã«ã—ã¾ã™"); bossDefeatedOverlay.style.display = 'none'; }, 500); }

Â  Â  Â  Â  Â  Â  }, 3000);



Â  Â  Â  Â  Â  Â  resultMessage = `ã™ã”ã„ï¼ãƒœã‚¹ ${currentEnemy.name} ã‚’ãŸãŠã—ãŸï¼ğŸ†`;



Â  Â  Â  Â  } else {

Â  Â  Â  Â  Â  Â  console.log("endBattle: é€šå¸¸ã®æ•µæ’ƒç ´ã¨åˆ¤å®šã•ã‚Œã¾ã—ãŸ");

Â  Â  Â  Â  Â  Â  playSound('enemyDefeated');

Â  Â  Â  Â  Â  Â  resultMessage = `ğŸ‰å‹åˆ©ï¼ ${currentEnemy.name} ã‚’ãŸãŠã—ãŸï¼ğŸ‰`;

Â  Â  Â  Â  }



Â  Â  Â  Â  saveHighestStage(gameMode, currentStage);

Â  Â  Â  Â  currentStage++;



Â  Â  Â  Â  if (currentStage > maxStage) { console.log("endBattle: å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ"); resultMessage += " ğŸ†å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã†ï¼ğŸ†"; if (startBtn) { startBtn.style.display = "none"; } else { console.error("endBattle: startBtn (ã‚¯ãƒªã‚¢æ™‚éè¡¨ç¤ºç”¨) ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼"); } } else { console.log("endBattle: æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã«é€²ã¿ã¾ã™"); nextButtonText = `æ¬¡ã®æ•µ (Lv${currentStage}) ã¨æˆ¦ã†ï¼`; if (startBtn) { startBtn.style.display = "inline-block"; } else { console.error("endBattle: startBtn (æ¬¡ã¸è¡¨ç¤ºç”¨) ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼"); } }



Â  Â  } else { // æ•—åŒ—ã¾ãŸã¯æ™‚é–“åˆ‡ã‚Œã®å ´åˆ

Â  Â  Â  Â  console.log("endBattle: æ•—åŒ—ã¾ãŸã¯æ™‚é–“åˆ‡ã‚Œã¨åˆ¤å®šã•ã‚Œã¾ã—ãŸ");

Â  Â  Â  Â  isVictory = false; resultMessage = playerHP <= 0 ? "ğŸ˜­æ•—åŒ—...ã¾ãŸæŒ‘æˆ¦ã—ã¦ã­ï¼" : "æ™‚é–“åˆ‡ã‚Œ...ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ï¼"; nextButtonText = "å†æŒ‘æˆ¦ï¼"; if (startBtn) { startBtn.style.display = "inline-block"; } else { console.error("endBattle: startBtn (å†æŒ‘æˆ¦è¡¨ç¤ºç”¨) ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼"); }

Â  Â  }



Â  Â  if (battleLog) { console.log("endBattle: ãƒãƒˆãƒ«ãƒ­ã‚°ã«çµæœã‚’è¡¨ç¤ºã—ã¾ã™:", resultMessage); battleLog.textContent = resultMessage; } else { console.error("endBattle: battleLog ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼"); }

Â  Â  if (nextButtonText) { if (startBtn) { console.log("endBattle: ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®šã—ã¾ã™:", nextButtonText); startBtn.textContent = nextButtonText; } else { console.error("endBattle: startBtn (ãƒ†ã‚­ã‚¹ãƒˆè¨­å®šç”¨) ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼"); } }



Â  Â  console.log("endBattle: èƒŒæ™¯ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æ¼”å‡ºã‚’é–‹å§‹ã—ã¾ã™");

Â  Â  document.body.classList.add(isVictory ? 'feedback-correct' : 'feedback-wrong');

Â  Â  setTimeout(() => { document.body.classList.remove('feedback-correct', 'feedback-wrong'); }, 1000);



Â  Â  if (document.body.classList.contains('boss-battle-bg')) { console.log("endBattle: ãƒœã‚¹æˆ¦èƒŒæ™¯ã‚’è§£é™¤ã—ã¾ã™"); setTimeout(() => { document.body.classList.remove('boss-battle-bg'); }, 500); }

Â  Â  console.log("endBattle: é–¢æ•°çµ‚äº†");

}

// --- endBattleé–¢æ•° --- (ã“ã“ã¾ã§ã‚³ãƒ”ãƒ¼)Â  Â  Â  // --- ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰é–¢é€£é–¢æ•° ---

Â  Â  function generateTrainingProblem(type) { let num1, num2, answer, questionText, op; switch (type) { case 'addsub1': if (Math.random() < 0.6) { op = '+'; do { num1 = Math.floor(Math.random() * 10); num2 = Math.floor(Math.random() * (10 - num1)); } while (num1 === 0 && num2 === 0); answer = num1 + num2; } else { op = '-'; num1 = Math.floor(Math.random() * 6) + 5; num2 = Math.floor(Math.random() * num1) + 1; answer = num1 - num2; } break; case 'addsub2': if (Math.random() < 0.5) { op = '+'; num1 = Math.floor(Math.random()*80)+10; num2 = Math.floor(Math.random()*80)+10; answer = num1 + num2; } else { op = '-'; num1 = Math.floor(Math.random()*80)+20; num2 = Math.floor(Math.random()*(num1-10))+10; answer = num1 - num2; } break; case 'mul': op = 'Ã—'; num1 = Math.floor(Math.random() * 8) + 2; num2 = Math.floor(Math.random() * 8) + 2; answer = num1 * num2; break; case 'div': op = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; answer = Math.floor(Math.random() * 8) + 2; num1 = num2 * answer; break; default: op = '+'; do { num1 = Math.floor(Math.random() * 10); num2 = Math.floor(Math.random() * (10 - num1)); } while (num1 === 0 && num2 === 0); answer = num1 + num2; } questionText = `${num1} ${op} ${num2}`; return { q: questionText, a: answer }; }

Â  Â  function showTrainingQuestion() { if (trainingTimeRemaining <= 0) return; currentTrainingProblem = generateTrainingProblem(trainingType); trainingQuestion.textContent = currentTrainingProblem.q; const choices = generateChoices(currentTrainingProblem.a); trainingAnswerChoices.innerHTML = ""; trainingEnemyDisplay.classList.remove('defeated'); choices.forEach(choice => { const btn = document.createElement("button"); btn.textContent = choice; btn.className = "choice-btn"; btn.onclick = () => handleTrainingAnswer(choice); trainingAnswerChoices.appendChild(btn); }); battleInProgress = false; }

Â  Â  function handleTrainingAnswer(selectedAnswer) { if (battleInProgress || trainingTimeRemaining <= 0) return; battleInProgress = true; const choiceButtons = trainingAnswerChoices.querySelectorAll('.choice-btn'); choiceButtons.forEach(btn => btn.disabled = true); playSound('tap'); if (selectedAnswer === currentTrainingProblem.a) { playSound('hit_perfect'); showFeedback("Correct!", "perfect"); trainingScore++; trainingScoreDisplay.textContent = `ãŸãŠã—ãŸæ•°: ${trainingScore}`; trainingEnemyDisplay.classList.add('defeated'); playSound('enemyDefeated'); } else { playSound('wrong'); showFeedback("Wrong!", "wrong"); trainingTimeRemaining = Math.max(0, trainingTimeRemaining - 1); trainingTimer.textContent = `ã®ã“ã‚Šæ™‚é–“: ${trainingTimeRemaining}ç§’`; } setTimeout(showTrainingQuestion, 200); }

Â  Â  function updateTrainingTimer() { trainingTimeRemaining--; trainingTimer.textContent = `ã®ã“ã‚Šæ™‚é–“: ${trainingTimeRemaining}ç§’`; if (trainingTimeRemaining <= 0) { endTraining(); } }

Â  Â  function startTraining(type) { gameMode = 'training'; trainingType = type; trainingScore = 0; trainingTimeRemaining = trainingTimeLimit; battleInProgress = false; modeSelectScreen.style.display = 'none'; trainingTypeSelectScreen.style.display = 'none'; battleScreen.style.display = 'none'; trainingScreen.style.display = 'flex'; trainingResultScreen.style.display = 'none'; document.body.className = 'training-bg'; trainingTimer.textContent = `ã®ã“ã‚Šæ™‚é–“: ${trainingTimeRemaining}ç§’`; trainingScoreDisplay.textContent = `ãŸãŠã—ãŸæ•°: ${trainingScore}`; trainingEnemyDisplay.textContent = 'ğŸ’§'; stopBgm(); playBgm('bgmTraining'); showTrainingQuestion(); trainingTimerInterval = setInterval(updateTrainingTimer, 1000); }

Â  Â  function endTraining() { clearInterval(trainingTimerInterval); battleInProgress = true; stopBgm(); finalScore.textContent = `${trainingScore} ã²ã ãŸãŠã—ãŸï¼`; const bestScore = loadBestScore(trainingType); personalBest.textContent = `ã˜ã“ãƒ™ã‚¹ãƒˆ: ${bestScore} ã²ã`; if (saveBestScore(trainingType, trainingScore)) { personalBest.textContent += " âœ¨æ–°è¨˜éŒ²ï¼âœ¨"; } trainingScreen.style.display = 'none'; trainingResultScreen.style.display = 'flex'; }

Â  Â  // --- ãƒ¢ãƒ¼ãƒ‰é¸æŠ/ã‚¹ã‚¿ãƒ¼ãƒˆæ–¹æ³•é¸æŠ é–¢é€£ ---

Â  Â  function showModeSelect() { stopBgm(); document.body.className = ''; modeSelectScreen.style.display = 'flex'; startMethodScreen.style.display = 'none'; battleScreen.style.display = 'none'; trainingTypeSelectScreen.style.display = 'none'; trainingScreen.style.display = 'none'; trainingResultScreen.style.display = 'none'; }

Â  Â  function selectMode(selectedMode) { playSound('tap'); gameMode = selectedMode; highestClearedStage = loadHighestStage(gameMode); modeSelectScreen.style.display = 'none'; startMethodScreen.style.display = 'flex'; if (highestClearedStage > 0 && highestClearedStage < maxStage) { const nextStage = highestClearedStage + 1; continueFromLastBtn.textContent = `ã¤ã¥ãã‹ã‚‰ (Lv ${nextStage})`; continueFromLastBtn.style.display = 'inline-block'; continueFromLastBtn.disabled = false; } else { continueFromLastBtn.style.display = 'none'; continueFromLastBtn.disabled = true; } loadBgmSetting(); }

Â  Â  function startGameFlow() { playSound('tap'); startMethodScreen.style.display = 'none'; battleScreen.style.display = 'flex'; document.body.className = ''; startBattle(); }

Â  Â  // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---

Â  Â  grade1ModeBtn.addEventListener("click", () => selectMode('grade1')); grade2ModeBtn.addEventListener("click", () => selectMode('grade2')); grade3ModeBtn.addEventListener("click", () => selectMode('grade3')); grade4ModeBtn.addEventListener("click", () => selectMode('grade4')); grade5ModeBtn.addEventListener("click", () => selectMode('grade5'));

Â  Â  trainingModeBtn.addEventListener("click", () => { playSound('tap'); modeSelectScreen.style.display = 'none'; trainingTypeSelectScreen.style.display = 'flex'; stopBgm(); });

Â  Â  startFromBeginningBtn.addEventListener('click', () => { currentStage = 1; startGameFlow(); });

Â  Â  continueFromLastBtn.addEventListener('click', () => { currentStage = highestClearedStage + 1; if (currentStage > maxStage) currentStage = maxStage; startGameFlow(); });

Â  Â  startBtn.addEventListener("click", () => { playSound('tap'); enemyCharacter.classList.remove('defeated'); startBattle(); });

Â  Â  document.querySelectorAll('.training-type-btn').forEach(button => { button.addEventListener('click', (e) => { playSound('tap'); const type = e.target.dataset.trainingType; startTraining(type); }); });

Â  Â  retryTrainingBtn.addEventListener('click', () => { playSound('tap'); trainingResultScreen.style.display = 'none'; startTraining(trainingType); });

Â  Â  backToModeSelectBtn.addEventListener('click', showModeSelect);

Â  Â  backToModeSelectBtnFromTraining.addEventListener('click', showModeSelect);

Â  Â  // --- åˆæœŸåŒ–å‡¦ç† ---

Â  Â  loadBgmSetting(); playerHPText.textContent = playerHP; updateHPBar('playerHPBar', playerHP, playerMaxHP); showModeSelect();



Â  </script>

</body>

</html>
