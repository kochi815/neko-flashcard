<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã­ã“ãƒãƒˆãƒ«ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ç­‰ --- */
        body { font-family: 'M PLUS Rounded 1c', sans-serif; text-align: center; background-color: #fdf6e3; margin: 0; padding: 15px; transition: background-color 0.3s ease-out; position: relative; min-height: 100vh; box-sizing: border-box; }
        body.boss-battle-bg { background-color: #ffebee; }
        h1 { font-size: 1.8em; color: #d35400; margin-bottom: 10px; }
        button { font-family: 'M PLUS Rounded 1c', sans-serif; font-weight: bold; cursor: pointer; transition: background-color 0.2s, transform 0.1s; border: none; }
        button:active:not(:disabled) { transform: scale(0.97); }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        #bgmToggleBtn { position: absolute; top: 15px; right: 15px; font-size: 1.8em; background: none; border: none; padding: 5px; opacity: 0.7; z-index: 20; }
        #bgmToggleBtn:hover { opacity: 1; }
        #bgmToggleBtn.muted::before { content: "ğŸ”‡"; font-size: 1em; }
        #bgmToggleBtn:not(.muted)::before { content: "ğŸ”Š"; font-size: 1em; }

        /* --- ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ --- */
        #modeSelectScreen { padding-top: 30px; display: flex; flex-direction: column; align-items: center; gap: 10px; } /* gapèª¿æ•´ */
        #modeSelectScreen h2 { font-size: 1.5em; color: #555; margin-bottom: 10px;}
        .mode-btn { font-size: 1.2em; padding: 12px 30px; border-radius: 20px; color: white; min-width: 220px; margin-bottom: 5px; } /* ã‚µã‚¤ã‚ºèª¿æ•´ */
        #grade1ModeBtn { background-color: #87cefa; } #grade2ModeBtn { background-color: #ffb6c1; } /* ãƒ”ãƒ³ã‚¯ */ #grade3ModeBtn { background-color: #90ee90; } /* ç·‘ */ #grade4ModeBtn { background-color: #ffcc80; } #grade5ModeBtn { background-color: #ba55d3; } /* ç´« */
        #grade1ModeBtn:hover { background-color: #5abcd8; } #grade2ModeBtn:hover { background-color: #ff9aaa; } #grade3ModeBtn:hover { background-color: #66cdab; } #grade4ModeBtn:hover { background-color: #ffa726; } #grade5ModeBtn:hover { background-color: #9932cc; }

        /* --- ã‚¹ã‚¿ãƒ¼ãƒˆæ–¹æ³•é¸æŠç”»é¢ --- */
        #startMethodScreen { padding-top: 50px; display: none; flex-direction: column; align-items: center; gap: 15px; }
        #startMethodScreen h2 { font-size: 1.5em; color: #555; }
        .start-method-btn { font-size: 1.4em; padding: 15px 40px; border-radius: 25px; color: white; min-width: 250px; }
        #startFromBeginningBtn { background-color: #a5d6a7; } #continueFromLastBtn { background-color: #90caf9; }
        #startFromBeginningBtn:hover { background-color: #81c784; } #continueFromLastBtn:hover:not(:disabled) { background-color: #64b5f6; }

        /* --- ãƒãƒˆãƒ«ç”»é¢ --- */
        #battleScreen { display: none; flex-direction: column; align-items: center; gap: 10px; }
        .character-area { border: 2px solid #eee; border-radius: 10px; padding: 10px; margin: 5px 0; width: 90%; max-width: 400px; background-color: rgba(255, 255, 255, 0.8); box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; } #enemyArea { border-color: #e74c3c; } #playerArea { border-color: #3498db; } .character-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-weight: bold; } .character-name { font-size: 1.1em; } .character-hp-text { font-size: 1em; } .hp-bar-container { height: 15px; background-color: #eee; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; } .hp-bar { height: 100%; width: 100%; border-radius: 6px; transition: width 0.3s ease-in-out; } #enemyArea .hp-bar { background-color: #f44336; } #playerArea .hp-bar { background-color: #4caf50; } .character-display { font-size: 3em; margin: 5px 0; transition: transform 0.1s ease-in-out, opacity 0.3s ease-out; opacity: 1; } .character-display.defeated { opacity: 0; transform: scale(0.5) rotate(30deg); } #question { font-size: 2.2em; margin: 15px 0; color: #2c3e50; font-weight: 700; min-height: 1.3em; } #answerChoices { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 10px; margin-bottom: 10px; } .choice-btn { font-size: 1.3em; padding: 10px 18px; border-radius: 8px; border: 2px solid #f39c12; background-color: #fff; color: #333; min-width: 70px; } .choice-btn:hover:not(:disabled) { background-color: #fef9e7; } .choice-btn:disabled { background-color: #eee; border-color: #ccc; color: #aaa; } #battleLog { font-size: 1.1em; min-height: 1.5em; margin: 10px 0; color: #c0392b; font-weight: bold; } #startBtn { font-size: 1.1em; padding: 10px 30px; margin: 15px 0 5px 0; border-radius: 20px; background-color: #e67e22; color: white; min-width: 160px; } #startBtn:hover { background-color: #d35400; }
        #feedbackDisplay { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%) scale(0.8); font-size: 3em; font-weight: bold; color: #fff; background-color: rgba(0, 0, 0, 0.6); padding: 10px 25px; border-radius: 15px; opacity: 0; transition: opacity 0.2s ease-out, transform 0.2s ease-out; pointer-events: none; z-index: 10; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); } #feedbackDisplay.show { opacity: 1; transform: translate(-50%, -50%) scale(1); } #feedbackDisplay.critical { color: #ffeb3b; } #feedbackDisplay.perfect { color: #81d4fa; } #feedbackDisplay.great { color: #a5d6a7; } #feedbackDisplay.good { color: #fff; } #feedbackDisplay.slow { color: #ef9a9a; } #feedbackDisplay.wrong { color: #f44336; background-color: rgba(255, 255, 255, 0.8); text-shadow: none;}
        #comboDisplay { position: absolute; top: 60%; left: 50%; transform: translateX(-50%); font-size: 2.5em; font-weight: bold; color: #ff9800; opacity: 0; transition: opacity 0.2s, transform 0.2s; pointer-events: none; z-index: 5; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); } #comboDisplay.show { opacity: 1; animation: comboBounce 0.3s ease-out; } #comboDisplay.great-combo { color: #f44336; } #comboDisplay.amazing-combo { color: #9c27b0; }
        @keyframes comboBounce { 0% { transform: translateX(-50%) scale(0.8); } 50% { transform: translateX(-50%) scale(1.1); } 100% { transform: translateX(-50%) scale(1); } } @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px); } 50% { transform: translateX(3px); } 75% { transform: translateX(-3px); } } .shake-animation { animation: shake 0.2s ease-in-out; } body.feedback-flash { background-color: #fff3e0; }
        @media (max-width: 600px) { h1 { font-size: 1.6em; } .character-display { font-size: 2.5em; } #question { font-size: 1.8em; } .choice-btn { font-size: 1.1em; padding: 8px 15px; min-width: 60px; } #startBtn { font-size: 1em; padding: 10px 25px; min-width: 140px; } #battleLog { font-size: 1em; } #feedbackDisplay { font-size: 2.5em; padding: 8px 20px;} #comboDisplay { font-size: 2em; top: 55%; } #bgmToggleBtn { font-size: 1.5em; top: 10px; right: 10px; } .mode-btn, .start-method-btn { font-size: 1.2em; padding: 12px 30px; min-width: 200px; } }
    </style>
</head>
<body>
    <h1>ã­ã“ãƒãƒˆãƒ«ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h1>
    <button id="bgmToggleBtn">ğŸ”Š</button>

    <div id="modeSelectScreen">
        <h2>ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­ï¼</h2>
        <button id="grade1ModeBtn" class="mode-btn">ğŸ’ ï¼‘ã­ã‚“ã›ã„</button>
        <button id="grade2ModeBtn" class="mode-btn">ğŸ’ ï¼’ã­ã‚“ã›ã„</button>
        <button id="grade3ModeBtn" class="mode-btn">ğŸ“š ï¼“ã­ã‚“ã›ã„</button>
        <button id="grade4ModeBtn" class="mode-btn">ğŸ“š ï¼”ã­ã‚“ã›ã„</button>
        <button id="grade5ModeBtn" class="mode-btn">ğŸ“ ï¼•ã­ã‚“ã›ã„</button>
    </div>

    <div id="startMethodScreen" style="display: none;"> <h2>ã©ã†ã‚„ã£ã¦ã¯ã˜ã‚ã‚‹ï¼Ÿ</h2> <button id="startFromBeginningBtn" class="start-method-btn">ã¯ã˜ã‚ã‹ã‚‰ (Lv 1)</button> <button id="continueFromLastBtn" class="start-method-btn" style="display: none;">ã¤ã¥ãã‹ã‚‰ (Lv X)</button> </div>
    <div id="battleScreen"> <div id="enemyArea" class="character-area"> <div class="character-info"> <span class="character-name" id="enemyName"></span> <span class="character-hp-text">HP: <span id="enemyHPText"></span></span> </div> <div class="hp-bar-container"> <div class="hp-bar" id="enemyHPBar"></div> </div> <div class="character-display" id="enemyCharacter"></div> </div> <div id="questionArea"> <div id="question"></div> <div id="answerChoices"></div> </div> <div id="playerArea" class="character-area"> <div class="character-display" id="playerCharacter">ğŸ˜º</div> <div class="hp-bar-container"> <div class="hp-bar" id="playerHPBar"></div> </div> <div class="character-info"> <span class="character-name">ã«ã‚ƒã‚“ãŸã‚ã†</span> <span class="character-hp-text">HP: <span id="playerHPText"></span></span> </div> </div> <div id="infoArea"> <div id="battleLog"></div> <button id="startBtn"></button> </div> </div>
    <div id="feedbackDisplay"></div> <div id="comboDisplay"></div>

  <script>
    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ç­‰ ---
    let currentStage = 1; let gameMode = ''; let playerMaxHP = 15; let playerHP = playerMaxHP;
    let currentEnemy = {}; let enemyMaxHP = 10; let enemyHP = enemyMaxHP;
    let problems = []; let currentProblemIndex = 0; let questionStartTime;
    let battleInProgress = false; let comboCount = 0; let isBgmEnabled = true;
    const BGM_KEY = 'nekobattle_bgmEnabled_v1'; let questionsForThisStage = 10;
    // â˜…å¤‰æ›´: ãƒ¢ãƒ¼ãƒ‰åˆ¥localStorageã‚­ãƒ¼
    const HIGHEST_STAGE_KEY_PREFIX = 'nekobattle_highestStage_';
    let highestClearedStage = 0;

    // --- DOMè¦ç´ å–å¾— ---
    const modeSelectScreen = document.getElementById("modeSelectScreen");
    // â˜…å¤‰æ›´: ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³å–å¾—ã‚’5ã¤ã«
    const grade1ModeBtn = document.getElementById("grade1ModeBtn"); const grade2ModeBtn = document.getElementById("grade2ModeBtn"); const grade3ModeBtn = document.getElementById("grade3ModeBtn"); const grade4ModeBtn = document.getElementById("grade4ModeBtn"); const grade5ModeBtn = document.getElementById("grade5ModeBtn");
    const startMethodScreen = document.getElementById("startMethodScreen"); const startFromBeginningBtn = document.getElementById("startFromBeginningBtn"); const continueFromLastBtn = document.getElementById("continueFromLastBtn"); const battleScreen = document.getElementById("battleScreen"); const startBtn = document.getElementById("startBtn"); const questionDiv = document.getElementById("question"); const answerChoicesDiv = document.getElementById("answerChoices"); const battleLog = document.getElementById("battleLog"); const enemyArea = document.getElementById("enemyArea"); const enemyName = document.getElementById("enemyName"); const enemyHPText = document.getElementById("enemyHPText"); const enemyHPBar = document.getElementById("enemyHPBar"); const enemyCharacter = document.getElementById("enemyCharacter"); const playerArea = document.getElementById("playerArea"); const playerHPText = document.getElementById("playerHPText"); const playerHPBar = document.getElementById("playerHPBar"); const playerCharacter = document.getElementById("playerCharacter"); const feedbackDisplay = document.getElementById("feedbackDisplay"); const comboDisplay = document.getElementById("comboDisplay"); const bgmToggleBtn = document.getElementById("bgmToggleBtn");

    // --- åŠ¹æœéŸ³ã¨BGM ---
    const sounds = { tap: new Audio('tap.mp3'), hitEnemy: new Audio('hit_enemy.mp3'), hitPlayer: new Audio('hit_player.mp3'), wrong: new Audio('wrong.mp3'), enemyDefeated: new Audio('enemy_defeated.mp3'), criticalHit: new Audio('critical_hit.mp3'), bgmNormal: new Audio('bgm_normal.mp3'), bgmBoss: new Audio('bgm_boss.mp3') };
    sounds.bgmNormal.loop = true; sounds.bgmBoss.loop = true; sounds.bgmNormal.volume = 0.4; sounds.bgmBoss.volume = 0.35; let currentBgm = null;
    function playSound(soundName) { if (!sounds[soundName]) return; sounds[soundName].currentTime = 0; sounds[soundName].play().catch(error => console.log(`Sound play failed (${soundName}):`, error)); }
    function playBgm(bgmName) { if (!isBgmEnabled || !sounds[bgmName]) return; if (currentBgm && currentBgm !== sounds[bgmName]) { currentBgm.pause(); } if (sounds[bgmName].paused) { sounds[bgmName].play().catch(error => console.log(`BGM play failed (${bgmName}):`, error)); currentBgm = sounds[bgmName]; } else { currentBgm = sounds[bgmName]; } }
    function stopBgm() { if (currentBgm) { currentBgm.pause(); currentBgm.currentTime = 0; currentBgm = null; } }
    function updateBgmButton() { if (isBgmEnabled) { bgmToggleBtn.classList.remove('muted'); bgmToggleBtn.textContent = 'ğŸ”Š'; } else { bgmToggleBtn.classList.add('muted'); bgmToggleBtn.textContent = 'ğŸ”‡'; } }
    function loadBgmSetting() { const savedSetting = localStorage.getItem(BGM_KEY); isBgmEnabled = (savedSetting !== null) ? JSON.parse(savedSetting) : true; updateBgmButton(); }
    bgmToggleBtn.addEventListener('click', () => { isBgmEnabled = !isBgmEnabled; localStorage.setItem(BGM_KEY, JSON.stringify(isBgmEnabled)); updateBgmButton(); if (isBgmEnabled) { if (!currentBgm && battleInProgress && currentEnemy) { playBgm(currentEnemy.type === 'boss' ? 'bgmBoss' : 'bgmNormal'); } } else { stopBgm(); } playSound('tap'); });

    // --- â˜… æ•µãƒ‡ãƒ¼ã‚¿ Lv40ã¾ã§æ‹¡å¼µ & ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ– â˜… ---
    const enemies = {
        1: { name: "ã·ã‚‹ã·ã‚‹ã‚¹ãƒ©ã‚¤ãƒ ", emoji: "ğŸ’§", hp: 10, type: "normal" }, 2: { name: "ã‚¹ãƒ©ã‚¤ãƒ ", emoji: "ğŸ’§", hp: 12, type: "normal" }, 3: { name: "ãŠãŠããªã‚¹ãƒ©ã‚¤ãƒ ", emoji: "ğŸ’§", hp: 15, type: "normal" },
        4: { name: "ã¶ãã¿ãªã‚³ã‚¦ãƒ¢ãƒª", emoji: "ğŸ¦‡", hp: 18, type: "normal" },
        5: { name: "ãƒœã‚¹ ã‚³ã‚¦ãƒ¢ãƒªãƒ­ãƒ¼ãƒ‰", emoji: "ğŸ¦‡ğŸ‘‘", hp: 28, type: "boss" }, // Lv5 Boss
        6: { name: "ã•ã¾ã‚ˆã†ã‚´ãƒ¼ã‚¹ãƒˆ", emoji: "ğŸ‘»", hp: 22, type: "normal" }, 7: { name: "ã‚´ãƒ¼ã‚¹ãƒˆãƒãƒ¼ãƒ•", emoji: "ğŸ‘»", hp: 26, type: "normal" },
        8: { name: "ãƒ›ãƒãƒ›ãƒã‚¹ã‚±ãƒ«ãƒˆãƒ³", emoji: "ğŸ’€", hp: 30, type: "normal" }, 9: { name: "ã‚¹ã‚±ãƒ«ãƒˆãƒ³ãƒŠã‚¤ãƒˆ", emoji: "ğŸ’€", hp: 35, type: "normal" },
        10: { name: "ãƒœã‚¹ ã‚´ãƒ–ãƒªãƒ³ã‚·ãƒ£ãƒ¼ãƒãƒ³", emoji: "ğŸ‘ºâœ¨", hp: 50, type: "boss" }, // Lv10 Boss
        11: { name: "ãã•ã£ãŸã—ãŸã„", emoji: "ğŸ§Ÿ", hp: 40, type: "normal" }, 12: { name: "ãƒãƒƒãƒ‰ãƒãƒ³ãƒ‰", emoji: "âœ‹", hp: 44, type: "normal" },
        13: { name: "ãƒãƒƒãƒ‰ãƒãƒ³ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼", emoji: "âœ‹", hp: 49, type: "normal" }, 14: { name: "ã‚¬ãƒ¼ã‚´ã‚¤ãƒ«", emoji: "ğŸ—¿ğŸ¦‡", hp: 55, type: "normal" }, // çµµæ–‡å­—çµ„ã¿åˆã‚ã›
        15: { name: "ãƒœã‚¹ ã‚µã‚¤ã‚¯ãƒ­ãƒ—ã‚¹", emoji: "ğŸ‘ï¸", hp: 75, type: "boss" }, // Lv15 Boss
        16: { name: "ã‚ªãƒ¼ã‚¯", emoji: "ğŸ—", hp: 65, type: "normal" }, 17: { name: "ã‚ªãƒ¼ã‚¯ãƒªãƒ¼ãƒ€ãƒ¼", emoji: "ğŸ—", hp: 72, type: "normal" },
        18: { name: "ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹", emoji: "ğŸ‚", hp: 80, type: "normal" }, 19: { name: "ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹ï¼ˆå…„ï¼‰", emoji: "ğŸ‚", hp: 88, type: "normal" },
        20: { name: "ãƒœã‚¹ ãƒªãƒƒãƒ", emoji: "ğŸ’€ğŸ‘‘", hp: 115, type: "boss" }, // Lv20 Boss
        21: { name: "ã‚¢ã‚¤ã‚¹ã‚´ãƒ¼ãƒ¬ãƒ ", emoji: "ğŸ§ŠğŸ—¿", hp: 100, type: "normal" }, 22: { name: "ãƒ•ãƒ¬ã‚¤ãƒ ã‚´ãƒ¼ãƒ¬ãƒ ", emoji: "ğŸ”¥ğŸ—¿", hp: 100, type: "normal" },
        23: { name: "ã‚­ãƒ¡ãƒ©", emoji: "ğŸ¦ğŸğŸ", hp: 115, type: "normal" }, 24: { name: "ã‚­ãƒ¡ãƒ©ï¼ˆå¤‰ç•°ç¨®ï¼‰", emoji: "ğŸ¦ğŸğŸ", hp: 125, type: "normal" },
        25: { name: "ãƒœã‚¹ ã‚°ãƒªãƒ•ã‚©ãƒ³", emoji: "ğŸ¦…ğŸ¦", hp: 160, type: "boss" }, // Lv25 Boss
        26: { name: "ãƒ¬ãƒƒã‚µãƒ¼ãƒ‡ãƒ¼ãƒ¢ãƒ³", emoji: "ğŸ‘¿", hp: 140, type: "normal" }, 27: { name: "ã‚¢ãƒ¼ã‚¯ãƒ‡ãƒ¼ãƒ¢ãƒ³", emoji: "ğŸ”¥ğŸ‘¿", hp: 155, type: "normal" },
        28: { name: "ãƒ€ãƒ¼ã‚¯ãƒŠã‚¤ãƒˆ", emoji: "ğŸ›¡ï¸âš”ï¸", hp: 170, type: "normal" }, 29: { name: "ãƒ‡ã‚¹ãƒŠã‚¤ãƒˆ", emoji: "ğŸ’€âš”ï¸", hp: 185, type: "normal" },
        30: { name: "ãƒœã‚¹ ãƒ‰ãƒ©ã‚´ãƒ³ã‚¾ãƒ³ãƒ“", emoji: "ğŸ’€ğŸ‰", hp: 230, type: "boss" }, // Lv30 Boss
        31: { name: "ãƒ¡ã‚¿ãƒ«ã‚¹ãƒ©ã‚¤ãƒ ", emoji: "âš™ï¸ğŸ’§", hp: 50, type: "normal" }, // HPä½ã„ãŒç¡¬ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼Ÿï¼ˆä»Šã¯HPã®ã¿ï¼‰
        32: { name: "ã¯ãã‚Œãƒ¡ã‚¿ãƒ«", emoji: "âœ¨ğŸ’§", hp: 70, type: "normal" },
        33: { name: "é­”ç•Œã®é¨å£«", emoji: "ğŸ˜ˆâš”ï¸", hp: 250, type: "normal" },
        34: { name: "é­”ç•Œã®é­”é“å£«", emoji: "ğŸ˜ˆğŸ§™", hp: 270, type: "normal" },
        35: { name: "ãƒœã‚¹ ãƒ’ãƒ‰ãƒ©", emoji: "ğŸğŸğŸ", hp: 340, type: "boss" }, // Lv35 Boss
        36: { name: "é­”ç‹ã®ã—ã‚‚ã¹ãƒ»ç‚", emoji: "ğŸ”¥ã—ã‚‚ã¹", hp: 300, type: "normal" },
        37: { name: "é­”ç‹ã®ã—ã‚‚ã¹ãƒ»æ°·", emoji: "ğŸ§Šã—ã‚‚ã¹", hp: 300, type: "normal" },
        38: { name: "é­”ç‹ã®ã—ã‚‚ã¹ãƒ»é›·", emoji: "âš¡ã—ã‚‚ã¹", hp: 300, type: "normal" },
        39: { name: "é­”ç‹è¦ªè¡›éšŠé•·", emoji: "ğŸ‘‘ğŸ›¡ï¸âš”ï¸", hp: 360, type: "normal" },
        40: { name: "å¤§é­”ç‹ãƒ‹ãƒ£ãƒ³ã‚¾ãƒ¼ãƒ", emoji: "ğŸ˜ˆğŸ‘‘ğŸˆ", hp: 480, type: "boss" }, // FINAL BOSS
    };
    const maxStage = Object.keys(enemies).length;

    // --- localStorageé–¢é€£ (å¤‰æ›´ãªã—) ---
    function getHighestStageKey(mode) { return `${HIGHEST_STAGE_KEY_PREFIX}${mode}`; }
    function saveHighestStage(mode, stage) { const key = getHighestStageKey(mode); const currentHighest = loadHighestStage(mode); if (stage > currentHighest && stage <= maxStage) { localStorage.setItem(key, stage.toString()); console.log(`Mode ${mode}: Highest stage ${stage} saved.`); } }
    function loadHighestStage(mode) { const key = getHighestStageKey(mode); const savedStage = localStorage.getItem(key); return savedStage ? parseInt(savedStage, 10) : 0; }

    // --- â˜… å•é¡Œç”Ÿæˆé–¢æ•° (5ãƒ¢ãƒ¼ãƒ‰ x Lv40 ã®é›£æ˜“åº¦èª¿æ•´) â˜… ---
    function generateProblems(stage, mode, count) {
        const generatedProblems = [];
        let num1, num2, num3, answer, questionText, type, correctAnswerValue;

        for (let i = 0; i < count; i++) {
            correctAnswerValue = null;
            let problemTypeRand = Math.random(); // ã©ã®ç¨®é¡ã®å•é¡Œå‡ºã™ã‹

            // --- ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®å•é¡Œç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---
            if (mode === 'grade1') { // â˜… å°1ãƒ¢ãƒ¼ãƒ‰ (ã‹ãªã‚Šæ˜“åŒ–) â˜…
                if (stage <= 10) { // Lv1-10: ç°¡å˜ãªãŸã—ç®— (ç¹°ã‚Šä¸ŠãŒã‚Šãªã—)
                     type = '+'; do { num1 = Math.floor(Math.random() * 10); num2 = Math.floor(Math.random() * (10 - num1)); } while (num1 === 0 && num2 === 0); correctAnswerValue = num1 + num2; questionText = `${num1} + ${num2}`;
                } else if (stage <= 20) { // Lv11-20: ç°¡å˜ãªã²ãç®— (ç­”ãˆ>=0, 10ã‹ã‚‰å¼•ããªã©)
                    type = '-'; num1 = Math.floor(Math.random() * 6) + 5; num2 = Math.floor(Math.random() * num1) + 1; correctAnswerValue = num1 - num2; questionText = `${num1} - ${num2}`;
                } else if (stage <= 30) { // Lv21-30: ç¹°ã‚Šä¸ŠãŒã‚Šã‚ã‚Šã®ãŸã—ç®— (1æ¡+1æ¡)
                    type = '+'; num1 = Math.floor(Math.random() * 9) + 1; num2 = Math.floor(Math.random() * 9) + 1; correctAnswerValue = num1 + num2; questionText = `${num1} + ${num2}`;
                } else { // Lv31-40: ç°¡å˜ãªãŸã—ç®—è™«é£Ÿã„ç®— (?+b=c)
                    type = '+'; num2 = Math.floor(Math.random() * 8) + 1; correctAnswerValue = Math.floor(Math.random() * 8) + 1; num1 = correctAnswerValue + num2; if(num1 > 15) {num1=15; correctAnswerValue = num1-num2;}; questionText = `? + ${num2} = ${num1}`;
                }
            } else if (mode === 'grade2') { // â˜… å°2ãƒ¢ãƒ¼ãƒ‰ (æ—§å°1ç›¸å½“) â˜…
                if (stage <= 10) { // Lv1-10: ãŸã—ç®—(ç¹°ã‚Šä¸ŠãŒã‚Šæœ‰)/ã²ãç®—(ç¹°ã‚Šä¸‹ãŒã‚Šæœ‰, 2æ¡-1æ¡)
                    if(problemTypeRand < 0.5) { type = '+'; num1 = Math.floor(Math.random() * 9) + 1; num2 = Math.floor(Math.random() * 9) + 1; correctAnswerValue = num1 + num2; questionText = `${num1} + ${num2}`; }
                    else { type = '-'; num1 = Math.floor(Math.random() * 10) + 10; num2 = Math.floor(Math.random() * 9) + 1; correctAnswerValue = num1 - num2; questionText = `${num1} - ${num2}`; }
                } else if (stage <= 20) { // Lv11-20: ç°¡å˜ãªæ›ã‘ç®— (ä¹ä¹ 2,3,4,5ã®æ®µ)
                     type = 'Ã—'; num1 = Math.floor(Math.random() * 4) + 2; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`;
                } else if (stage <= 30) { // Lv21-30: æ›ã‘ç®— (ä¹ä¹ å…¨ä½“)
                     type = 'Ã—'; num1 = Math.floor(Math.random() * 8) + 2; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`;
                } else { // Lv31-40: ãŸã—ç®—/ã²ãç®—è™«é£Ÿã„ç®— (ç¹°ã‚Šä¸ŠãŒã‚Š/ä¸‹ãŒã‚Šå«ã‚€)
                     if (Math.random() < 0.5) { type = '+'; num1 = Math.floor(Math.random() * 9) + 1; correctAnswerValue = Math.floor(Math.random() * 9) + 1; num2 = num1 + correctAnswerValue; questionText = `${num1} + ? = ${num2}`; }
                     else { type = '-'; num1 = Math.floor(Math.random() * 10) + 10; correctAnswerValue = Math.floor(Math.random() * 8) + 1; num2 = num1 - correctAnswerValue; questionText = `${num1} - ? = ${num2}`; }
                }
            } else if (mode === 'grade3') { // â˜… å°3ãƒ¢ãƒ¼ãƒ‰ (æ–°è¨­) â˜…
                 if (stage <= 10) { // Lv1-10: æ›ã‘ç®—(ä¹ä¹å¾©ç¿’), ç°¡å˜ãªå‰²ã‚Šç®—(ä¹ä¹é€†)
                    if(problemTypeRand < 0.6) { type = 'Ã—'; num1 = Math.floor(Math.random() * 8) + 2; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`; }
                    else { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 8) + 2; num1 = num2 * correctAnswerValue; questionText = `${num1} Ã· ${num2}`; }
                 } else if (stage <= 20) { // Lv11-20: å°‘ã—é›£ã—ã„æ›ã‘ç®—(2æ¡x1æ¡ ç°¡å˜ãªã‚‚ã®), å‰²ã‚Šç®—å¾©ç¿’
                    if(problemTypeRand < 0.6) { type = 'Ã—'; num1 = Math.floor(Math.random()*6)+10; num2 = Math.floor(Math.random()*8)+2; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`; }
                     else { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 8) + 2; num1 = num2 * correctAnswerValue; questionText = `${num1} Ã· ${num2}`; }
                 } else if (stage <= 30) { // Lv21-30: 2æ¡+/-2æ¡ (ç­†ç®—ãƒ¬ãƒ™ãƒ«)
                     if(problemTypeRand < 0.5) { type = '+'; num1 = Math.floor(Math.random()*80)+10; num2 = Math.floor(Math.random()*80)+10; correctAnswerValue = num1 + num2; questionText = `${num1} + ${num2}`; }
                     else { type = '-'; num1 = Math.floor(Math.random()*80)+10; num2 = Math.floor(Math.random()*num1)+10; correctAnswerValue = num1 - num2; questionText = `${num1} - ${num2}`; }
                 } else { // Lv31-40: ç°¡å˜ãªæ›ã‘ç®—/å‰²ã‚Šç®—è™«é£Ÿã„ç®—
                     if (Math.random() < 0.5) { type = 'Ã—'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 8) + 2; num1 = num2 * correctAnswerValue; if (Math.random() < 0.5) { questionText = `? Ã— ${num2} = ${num1}`; } else { questionText = `${correctAnswerValue} Ã— ? = ${num1}`; correctAnswerValue = num2; } }
                      else { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; num3 = Math.floor(Math.random() * 8) + 2; num1 = num2 * num3; if (Math.random() < 0.5) { questionText = `${num1} Ã· ? = ${num3}`; correctAnswerValue = num2; } else { questionText = `? Ã· ${num2} = ${num3}`; correctAnswerValue = num1; } }
                 }
            } else if (mode === 'grade4') { // â˜… å°4ãƒ¢ãƒ¼ãƒ‰ (æ—§å°4ã‚’å°‘ã—æ˜“åŒ–) â˜…
                 if (stage <= 5) { // Lv1-5: æ›ã‘ç®—/å‰²ã‚Šç®— (ä¹ä¹ç¯„å›²)
                    if(problemTypeRand < 0.5) { type = 'Ã—'; num1 = Math.floor(Math.random() * 8) + 2; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`; }
                    else { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 8) + 2; num1 = num2 * correctAnswerValue; questionText = `${num1} Ã· ${num2}`; }
                } else if (stage <= 15) { // Lv6-15: 2æ¡+/-1,2æ¡ & ä¹ä¹/å‰²ã‚Šç®—å¾©ç¿’
                    if(problemTypeRand < 0.5) { // 2æ¡è¨ˆç®—
                        if (Math.random() < 0.5) { type = '+'; num1 = Math.floor(Math.random() * 80) + 10; num2 = Math.floor(Math.random() * 80) + 10; correctAnswerValue = num1 + num2; questionText = `${num1} + ${num2}`; }
                        else { type = '-'; num1 = Math.floor(Math.random() * 80) + 20; num2 = Math.floor(Math.random() * (num1-10)) + 10; correctAnswerValue = num1 - num2; questionText = `${num1} - ${num2}`; }
                    } else if (randType < 0.8) { type = 'Ã—'; num1 = Math.floor(Math.random() * 8) + 2; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`; }
                    else { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 8) + 2; num1 = num2 * correctAnswerValue; questionText = `${num1} Ã· ${num2}`; }
                } else if (stage <= 30) { // Lv16-30: å°‘ã—é›£ã—ã„å‰²ã‚Šç®—(3æ¡Ã·1æ¡ãªã©), æ›ã‘ç®—(2æ¡x1æ¡)
                    if(problemTypeRand < 0.6) { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 20) + 5; num1 = num2 * correctAnswerValue; questionText = `${num1} Ã· ${num2}`; }
                    else { type = 'Ã—'; num1 = Math.floor(Math.random()*10)+10; num2 = Math.floor(Math.random()*8)+2; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`; }
                } else { // Lv31-40: æ›ã‘ç®—/å‰²ã‚Šç®—è™«é£Ÿã„ç®—
                     if (Math.random() < 0.5) { type = 'Ã—'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 8) + 2; num1 = num2 * correctAnswerValue; if (Math.random() < 0.5) { questionText = `? Ã— ${num2} = ${num1}`; } else { questionText = `${correctAnswerValue} Ã— ? = ${num1}`; correctAnswerValue = num2; } }
                     else { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; num3 = Math.floor(Math.random() * 8) + 2; num1 = num2 * num3; if (Math.random() < 0.5) { questionText = `${num1} Ã· ? = ${num3}`; correctAnswerValue = num2; } else { questionText = `? Ã· ${num2} = ${num3}`; correctAnswerValue = num1; } }
                }
            } else { // mode === 'grade5' â˜… å°5ãƒ¢ãƒ¼ãƒ‰ (æ—§å°4ç›¸å½“) â˜…
                 if (stage <= 10) { // Lv1-10: 2æ¡è¨ˆç®—, ä¹ä¹/å‰²ã‚Šç®—å¾©ç¿’
                     if (randType < 0.5) { if (Math.random() < 0.5) { type = '+'; num1 = Math.floor(Math.random() * 80) + 10; num2 = Math.floor(Math.random() * 80) + 10; correctAnswerValue = num1 + num2; questionText = `${num1} + ${num2}`; } else { type = '-'; num1 = Math.floor(Math.random() * 80) + 20; num2 = Math.floor(Math.random() * (num1-10)) + 10; correctAnswerValue = num1 - num2; questionText = `${num1} - ${num2}`; } }
                     else if (randType < 0.8) { type = 'Ã—'; num1 = Math.floor(Math.random() * 8) + 2; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`; }
                     else { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 8) + 2; num1 = num2 * correctAnswerValue; questionText = `${num1} Ã· ${num2}`; }
                 } else if (stage <= 20) { // Lv11-20: é›£ã—ã„æ›ã‘ç®—/å‰²ã‚Šç®— (2æ¡x1æ¡, 3æ¡Ã·1æ¡)
                     if(problemTypeRand < 0.5) { type = 'Ã—'; num1 = Math.floor(Math.random()*11)+10; num2 = Math.floor(Math.random()*8)+2; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`; }
                     else { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 30) + 10; num1 = num2 * correctAnswerValue; questionText = `${num1} Ã· ${num2}`; }
                 } else if (stage <= 30) { // Lv21-30: 2æ¡x2æ¡ã®ç°¡å˜ãªã‚‚ã®, 3æ¡è¨ˆç®—
                     if(problemTypeRand < 0.5) { type = 'Ã—'; num1 = Math.floor(Math.random()*21)+10; num2 = Math.floor(Math.random()*9)+11; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`; }
                     else if (randType < 0.8) { type = '+'; num1 = Math.floor(Math.random()*800)+100; num2 = Math.floor(Math.random()*800)+100; correctAnswerValue = num1 + num2; questionText = `${num1} + ${num2}`; }
                     else { type = '-'; num1 = Math.floor(Math.random()*800)+100; num2 = Math.floor(Math.random()*num1)+1; correctAnswerValue = num1 - num2; questionText = `${num1} - ${num2}`; }
                 } else { // Lv31-40: è™«é£Ÿã„ç®— (æ›ã‘ç®—/å‰²ã‚Šç®—), è¤‡åˆçš„ãªå•é¡Œ
                     if (randType < 0.6) { // è™«é£Ÿã„ç®—
                         if (Math.random() < 0.5) { type = 'Ã—'; num2 = Math.floor(Math.random() * 8) + 2; correctAnswerValue = Math.floor(Math.random() * 12) + 2; num1 = num2 * correctAnswerValue; if (Math.random() < 0.5) { questionText = `? Ã— ${num2} = ${num1}`; } else { questionText = `${correctAnswerValue} Ã— ? = ${num1}`; correctAnswerValue = num2; } }
                         else { type = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; num3 = Math.floor(Math.random() * 12) + 2; num1 = num2 * num3; if (Math.random() < 0.5) { questionText = `${num1} Ã· ? = ${num3}`; correctAnswerValue = num2; } else { questionText = `? Ã· ${num2} = ${num3}`; correctAnswerValue = num1; } }
                     } else { // 2æ¡ x 2æ¡
                         type = 'Ã—'; num1 = Math.floor(Math.random()*40)+11; num2 = Math.floor(Math.random()*40)+11; correctAnswerValue = num1 * num2; questionText = `${num1} Ã— ${num2}`;
                     }
                 }
            }
            generatedProblems.push({ q: questionText, a: correctAnswerValue });
        }
        // ã‚·ãƒ£ãƒƒãƒ•ãƒ« (å¤‰æ›´ãªã—)
        for (let i = generatedProblems.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [generatedProblems[i], generatedProblems[j]] = [generatedProblems[j], generatedProblems[i]]; }
        return generatedProblems;
    }

    // --- é¸æŠè‚¢ç”Ÿæˆé–¢æ•° (å¤‰æ›´ãªã—) ---
    function generateChoices(correct) { const choices = new Set(); if (typeof correct !== 'number' || isNaN(correct)) { console.error("Invalid 'correct' answer:", correct); correct = 0; } correct = Math.round(correct); choices.add(correct); const maxAttempts = 50; let attempts = 0; while (choices.size < 6 && attempts < maxAttempts) { let wrongAnswer; const magnitude = Math.max(1, Math.abs(correct)); const range = Math.min(10, Math.ceil(magnitude * 0.4) + 4); let delta = Math.floor(Math.random() * (range * 2 + 1)) - range; if (Math.random() < 0.15) { delta += (Math.random() < 0.5 ? 1 : -1) * (Math.floor(Math.random() * 10) + 5); } if (delta === 0) delta = Math.random() < 0.5 ? 1 : -1; wrongAnswer = correct + delta; wrongAnswer = Math.round(wrongAnswer); if (wrongAnswer >= 0 && !choices.has(wrongAnswer)) { choices.add(wrongAnswer); } attempts++; } let filler = 1; while (choices.size < 6) { let fillChoice1 = Math.max(0, correct + filler); let fillChoice2 = Math.max(0, correct - filler); if (!choices.has(fillChoice1)) choices.add(fillChoice1); if (choices.size < 6 && fillChoice2 >= 0 && !choices.has(fillChoice2)) choices.add(fillChoice2); filler++; if (filler > correct + 20) break; } const choiceArray = Array.from(choices); choiceArray.sort(() => Math.random() - 0.5); return choiceArray; }
    // --- HPãƒãƒ¼æ›´æ–°é–¢æ•° (å¤‰æ›´ãªã—) ---
    function updateHPBar(elementId, currentHP, maxHP) { const bar = document.getElementById(elementId); const percentage = Math.max(0, (currentHP / maxHP) * 100); bar.style.width = `${percentage}%`; }
    // --- ã‚­ãƒ£ãƒ©æºã‚Œé–¢æ•° (å¤‰æ›´ãªã—) ---
    function shakeCharacter(elementId) { const characterElement = document.getElementById(elementId); characterElement.classList.add('shake-animation'); setTimeout(() => { characterElement.classList.remove('shake-animation'); }, 200); }
    // --- æ™‚é–“è©•ä¾¡è¡¨ç¤ºé–¢æ•° (å¤‰æ›´ãªã—) ---
    function showFeedback(text, type) { feedbackDisplay.textContent = text; feedbackDisplay.className = 'show ' + type; setTimeout(() => { feedbackDisplay.className = ''; }, 800); }
    // --- ã‚³ãƒ³ãƒœè¡¨ç¤ºæ›´æ–°é–¢æ•° (å¤‰æ›´ãªã—) ---
    function updateComboDisplay() { if (comboCount >= 3) { comboDisplay.textContent = `${comboCount} Combo!`; comboDisplay.classList.remove('great-combo', 'amazing-combo'); if (comboCount >= 10) { comboDisplay.classList.add('amazing-combo'); } else if (comboCount >= 5) { comboDisplay.classList.add('great-combo'); } comboDisplay.classList.add('show'); } else { comboDisplay.classList.remove('show'); } }
    // --- showQuestioné–¢æ•° (å¤‰æ›´ãªã—) ---
    function showQuestion() { battleInProgress = false; if (currentProblemIndex >= questionsForThisStage || playerHP <= 0 || enemyHP <= 0) { endBattle(); return; } if (!problems || problems.length <= currentProblemIndex) { console.error("Error: problems array invalid.", problems, currentProblemIndex); battleLog.textContent = "ã‚¨ãƒ©ãƒ¼ï¼šå•é¡Œæº–å‚™ã‚¨ãƒ©ãƒ¼"; endBattle(); return; } const p = problems[currentProblemIndex]; if (!p || typeof p.q === 'undefined' || typeof p.a === 'undefined') { console.error("Error: Invalid problem data.", p); battleLog.textContent = "ã‚¨ãƒ©ãƒ¼ï¼šå•é¡Œãƒ‡ãƒ¼ã‚¿ä¸æ­£"; endBattle(); return; } questionDiv.textContent = p.q; questionStartTime = Date.now(); battleLog.textContent = `Lv${currentStage} (${currentProblemIndex + 1}/${questionsForThisStage}) å•é¡Œï¼`; const choices = generateChoices(p.a); answerChoicesDiv.innerHTML = ""; if (Array.isArray(choices)) { choices.forEach(choice => { const btn = document.createElement("button"); btn.textContent = choice; btn.className = "choice-btn"; btn.onclick = () => handleAnswer(choice); answerChoicesDiv.appendChild(btn); }); } else { console.error("Error: choices not an array.", choices); battleLog.textContent = "ã‚¨ãƒ©ãƒ¼ï¼šé¸æŠè‚¢ç”Ÿæˆå¤±æ•—"; endBattle(); } }

    // --- â˜… handleAnsweré–¢æ•° (5ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ æ™‚é–“åŸºæº–ãƒ»ãƒšãƒŠãƒ«ãƒ†ã‚£èª¿æ•´) â˜… ---
    function handleAnswer(selectedAnswer) {
        if (battleInProgress) return;
        battleInProgress = true;
        const choiceButtons = answerChoicesDiv.querySelectorAll('.choice-btn');
        choiceButtons.forEach(btn => btn.disabled = true);
        playSound('tap');

        const elapsed = (Date.now() - questionStartTime) / 1000;
        const p = problems[currentProblemIndex];
        let feedbackClass = ''; let damageToEnemy = 0; let damageToPlayer = 0;
        let logMessage = ""; let feedbackText = ""; let feedbackType = ""; let isCritical = false;

        // --- ãƒ¢ãƒ¼ãƒ‰åˆ¥ æ™‚é–“åŸºæº–ã¨ãƒ€ãƒ¡ãƒ¼ã‚¸èª¿æ•´ ---
        let criticalTime, perfectTime, greatTime, goodTime, slowPenalty, wrongPenalty, baseDmgCrit, baseDmgPerf, baseDmgGreat, baseDmgGood;
        switch (gameMode) {
            case 'grade1': // è¶…ç·©å’Œ
                criticalTime = 3.0; perfectTime = 5.0; greatTime = 7.0; goodTime = 10.0;
                slowPenalty = 0; wrongPenalty = 1; // æ™‚é–“åˆ‡ã‚ŒãƒšãƒŠãªã—
                baseDmgCrit = 6; baseDmgPerf = 4; baseDmgGreat = 2; baseDmgGood = 1;
                break;
            case 'grade2': // ç·©å’Œ (æ—§å°1ç›¸å½“)
                criticalTime = 2.0; perfectTime = 3.5; greatTime = 5.0; goodTime = 7.5;
                slowPenalty = 1; wrongPenalty = 1;
                baseDmgCrit = 6; baseDmgPerf = 4; baseDmgGreat = 2; baseDmgGood = 1;
                break;
            case 'grade3': // æ¨™æº–
                criticalTime = 1.5; perfectTime = 2.5; greatTime = 4.0; goodTime = 6.0;
                slowPenalty = 1; wrongPenalty = 2;
                baseDmgCrit = 5; baseDmgPerf = 3; baseDmgGreat = 2; baseDmgGood = 1;
                break;
            case 'grade4': // å°‘ã—æŒ‘æˆ¦çš„ (æ—§å°4ç·©å’Œ)
                criticalTime = 1.0; perfectTime = 1.8; greatTime = 3.0; goodTime = 4.5;
                slowPenalty = 2; wrongPenalty = 3;
                baseDmgCrit = 6; baseDmgPerf = 4; baseDmgGreat = 2; baseDmgGood = 1;
                break;
            case 'grade5': // æŒ‘æˆ¦çš„ (æ—§å°4ç›¸å½“)
                criticalTime = 0.8; perfectTime = 1.5; greatTime = 2.5; goodTime = 4.0;
                slowPenalty = 2; wrongPenalty = 3;
                baseDmgCrit = 6; baseDmgPerf = 4; baseDmgGreat = 2; baseDmgGood = 1;
                break;
            default: // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ¨™æº–(grade3)
                criticalTime = 1.5; perfectTime = 2.5; greatTime = 4.0; goodTime = 6.0;
                slowPenalty = 1; wrongPenalty = 2;
                baseDmgCrit = 5; baseDmgPerf = 3; baseDmgGreat = 2; baseDmgGood = 1;
        }

        if (selectedAnswer === p.a) { // æ­£è§£
            comboCount++; let baseDamage = 0;
            if (elapsed < criticalTime) { baseDamage = baseDmgCrit; logMessage = `âœ¨Critical Hit!âœ¨ (${elapsed.toFixed(1)}ç§’) `; feedbackText = "Critical Hit!"; feedbackType = "critical"; isCritical = true; }
            else if (elapsed < perfectTime) { baseDamage = baseDmgPerf; logMessage = `Perfect! (${elapsed.toFixed(1)}ç§’) `; feedbackText = "Perfect!"; feedbackType = "perfect"; }
            else if (elapsed < greatTime) { baseDamage = baseDmgGreat; logMessage = `Great! (${elapsed.toFixed(1)}ç§’) `; feedbackText = "Great!"; feedbackType = "great"; }
            else if (elapsed < goodTime) { baseDamage = baseDmgGood; logMessage = `Good (${elapsed.toFixed(1)}ç§’) `; feedbackText = "Good"; feedbackType = "good"; }
            else { damageToPlayer = slowPenalty; logMessage = `Too slow... (${elapsed.toFixed(1)}ç§’) ${damageToPlayer>0 ? `è‡ªåˆ†ã«${damageToPlayer}ãƒ€ãƒ¡ãƒ¼ã‚¸!` : 'ãƒ€ãƒ¡ãƒ¼ã‚¸ãªã—'}`; feedbackText = "Too Slow..."; feedbackType = "slow"; comboCount = 0; }
            let comboBonus = 0; if (comboCount >= 5) comboBonus = 2; else if (comboCount >= 3) comboBonus = 1;
            damageToEnemy = baseDamage + comboBonus;
            if(damageToEnemy > 0) { logMessage += `æ•µã«${damageToEnemy}ãƒ€ãƒ¡ãƒ¼ã‚¸!`; if (comboCount >= 3) logMessage += ` (${comboCount} Combo!)`; feedbackClass = 'feedback-flash'; shakeCharacter('enemyCharacter'); playSound('hitEnemy'); if(isCritical) playSound('criticalHit'); }
            else if (damageToPlayer > 0) { feedbackClass = 'feedback-damage-player'; shakeCharacter('playerCharacter'); playSound('hitPlayer'); }
            else { feedbackClass = 'feedback-correct'; }
        } else { // ä¸æ­£è§£
            playSound('wrong'); damageToPlayer = wrongPenalty; logMessage = `Wrong! è‡ªåˆ†ã«${damageToPlayer}ãƒ€ãƒ¡ãƒ¼ã‚¸!`; feedbackText = "Wrong!"; feedbackType = "wrong";
            feedbackClass = 'feedback-wrong'; comboCount = 0; shakeCharacter('playerCharacter'); playSound('hitPlayer');
        }
        updateComboDisplay();
        enemyHP -= damageToEnemy; playerHP -= damageToPlayer;
        enemyHPText.textContent = Math.max(0, enemyHP); playerHPText.textContent = Math.max(0, playerHP);
        updateHPBar('enemyHPBar', enemyHP, enemyMaxHP); updateHPBar('playerHPBar', playerHP, playerMaxHP);
        battleLog.textContent = logMessage;
        if(feedbackText) showFeedback(feedbackText, feedbackType);
        if (feedbackClass) { document.body.classList.add(feedbackClass); setTimeout(() => { document.body.classList.remove(feedbackClass); }, 150); }
        currentProblemIndex++;
        setTimeout(() => { if (playerHP <= 0 || enemyHP <= 0 || currentProblemIndex >= questionsForThisStage) { endBattle(); } else { showQuestion(); } }, 1000);
    }

    // --- â˜… startBattleé–¢æ•° (5ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ HPè£œæ­£) â˜… ---
    function startBattle() {
        currentEnemy = enemies[currentStage] || enemies[maxStage]; // å­˜åœ¨ã—ãªã„ã‚¹ãƒ†ãƒ¼ã‚¸ã¯æœ€å¤§ã‚¹ãƒ†ãƒ¼ã‚¸ã®æ•µ
        enemyMaxHP = currentEnemy.hp;
        if (currentEnemy.type === 'boss') { enemyMaxHP = Math.floor(enemyMaxHP * 1.5); }

        // â˜… ãƒ¢ãƒ¼ãƒ‰åˆ¥HPè£œæ­£ â˜…
        let hpMultiplier = 1.0;
        switch (gameMode) {
            case 'grade1': hpMultiplier = 0.6; break; // 60%
            case 'grade2': hpMultiplier = 0.8; break; // 80%
            case 'grade3': hpMultiplier = 1.0; break; // 100% (åŸºæº–)
            case 'grade4': hpMultiplier = 1.1; break; // 110%
            case 'grade5': hpMultiplier = 1.2; break; // 120%
        }
        enemyMaxHP = Math.max(5, Math.floor(enemyMaxHP * hpMultiplier)); // æœ€ä½HP5ã‚’ä¿è¨¼

        enemyHP = enemyMaxHP;
        playerHP = playerMaxHP;
        currentProblemIndex = 0; comboCount = 0; updateComboDisplay();
        questionsForThisStage = (currentEnemy.type === 'boss') ? 20 : 15; // ãƒœã‚¹20å•ã€é€šå¸¸15å•
        problems = generateProblems(currentStage, gameMode, questionsForThisStage);

        enemyName.textContent = `${currentEnemy.emoji} ${currentEnemy.name} (Lv${currentStage})`;
        enemyHPText.textContent = enemyHP; playerHPText.textContent = playerHP;
        updateHPBar('enemyHPBar', enemyHP, enemyMaxHP); updateHPBar('playerHPBar', playerHP, playerMaxHP);
        enemyCharacter.textContent = currentEnemy.emoji;
        enemyCharacter.classList.remove('defeated');
        stopBgm();
        if (currentEnemy.type === 'boss') { document.body.classList.add('boss-battle-bg'); battleLog.textContent = `ğŸ”¥ãƒœã‚¹å‡ºç¾ï¼ ${currentEnemy.name} ãŒã‚ã‚‰ã‚ã‚ŒãŸï¼ğŸ”¥`; playBgm('bgmBoss'); }
        else { document.body.classList.remove('boss-battle-bg'); battleLog.textContent = `Lv${currentStage} ${currentEnemy.name} ãŒã‚ã‚‰ã‚ã‚ŒãŸï¼`; playBgm('bgmNormal'); }
        startBtn.style.display = "none";
        battleInProgress = false;
        setTimeout(showQuestion, 1500);
    }

    // --- endBattleé–¢æ•° (å¤‰æ›´ãªã—) ---
    function endBattle() { battleInProgress = true; answerChoicesDiv.innerHTML = ""; questionDiv.textContent = "Battle End!"; comboDisplay.classList.remove('show'); stopBgm(); let resultMessage = ""; let nextButtonText = ""; let isVictory = false; if (enemyHP <= 0) { isVictory = true; playSound('enemyDefeated'); enemyCharacter.classList.add('defeated'); resultMessage = `ğŸ‰å‹åˆ©ï¼ ${currentEnemy.name} ã‚’ãŸãŠã—ãŸï¼ğŸ‰`; if (currentEnemy.type === 'boss') { resultMessage += ` ã™ã”ã„ï¼ãƒœã‚¹ã‚’æ’ƒç ´ã—ãŸãï¼`; } saveHighestStage(gameMode, currentStage); currentStage++; if (currentStage > maxStage) { resultMessage += " ğŸ†å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã†ï¼ğŸ†"; startBtn.style.display = "none"; } else { nextButtonText = `æ¬¡ã®æ•µ (Lv${currentStage}) ã¨æˆ¦ã†ï¼`; startBtn.style.display = "inline-block"; } } else { resultMessage = playerHP <= 0 ? "ğŸ˜­æ•—åŒ—...ã¾ãŸæŒ‘æˆ¦ã—ã¦ã­ï¼" : "æ™‚é–“åˆ‡ã‚Œ...ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ï¼"; nextButtonText = "å†æŒ‘æˆ¦ï¼"; startBtn.style.display = "inline-block"; } battleLog.textContent = resultMessage; if (nextButtonText) { startBtn.textContent = nextButtonText; } document.body.classList.add(isVictory ? 'feedback-correct' : 'feedback-wrong'); setTimeout(() => { document.body.classList.remove('feedback-correct', 'feedback-wrong', 'boss-battle-bg'); }, 1000); }

    // --- â˜… ãƒ¢ãƒ¼ãƒ‰é¸æŠå‡¦ç† (5ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ) â˜… ---
    function selectMode(selectedMode) {
        playSound('tap');
        gameMode = selectedMode; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
        highestClearedStage = loadHighestStage(gameMode); // ã“ã®ãƒ¢ãƒ¼ãƒ‰ã®æœ€é«˜ã‚¯ãƒªã‚¢ã‚¹ãƒ†ãƒ¼ã‚¸èª­ã¿è¾¼ã¿
        modeSelectScreen.style.display = 'none'; // ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢éè¡¨ç¤º
        startMethodScreen.style.display = 'flex'; // ã‚¹ã‚¿ãƒ¼ãƒˆæ–¹æ³•é¸æŠç”»é¢è¡¨ç¤º

        if (highestClearedStage > 0 && highestClearedStage < maxStage) {
            const nextStage = highestClearedStage + 1;
            continueFromLastBtn.textContent = `ã¤ã¥ãã‹ã‚‰ (Lv ${nextStage})`;
            continueFromLastBtn.style.display = 'inline-block';
            continueFromLastBtn.disabled = false;
        } else {
            continueFromLastBtn.style.display = 'none';
            continueFromLastBtn.disabled = true;
        }
        loadBgmSetting(); // BGMè¨­å®šèª­ã¿è¾¼ã¿
    }

    // --- ã‚¹ã‚¿ãƒ¼ãƒˆæ–¹æ³•é¸æŠãƒœã‚¿ãƒ³ã®å‡¦ç† (å¤‰æ›´ãªã—) ---
    function startGameFlow() { playSound('tap'); startMethodScreen.style.display = 'none'; battleScreen.style.display = 'flex'; startBattle(); }
    startFromBeginningBtn.addEventListener('click', () => { currentStage = 1; startGameFlow(); });
    continueFromLastBtn.addEventListener('click', () => { currentStage = highestClearedStage + 1; if (currentStage > maxStage) currentStage = maxStage; startGameFlow(); });

    // --- â˜… ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ (5ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ) â˜… ---
    grade1ModeBtn.addEventListener("click", () => selectMode('grade1'));
    grade2ModeBtn.addEventListener("click", () => selectMode('grade2')); // â˜…è¿½åŠ 
    grade3ModeBtn.addEventListener("click", () => selectMode('grade3')); // â˜…è¿½åŠ 
    grade4ModeBtn.addEventListener("click", () => selectMode('grade4'));
    grade5ModeBtn.addEventListener("click", () => selectMode('grade5')); // â˜…è¿½åŠ 
    startBtn.addEventListener("click", () => { playSound('tap'); enemyCharacter.classList.remove('defeated'); startBattle(); });

    // --- åˆæœŸåŒ–å‡¦ç† (å¤‰æ›´ãªã—) ---
    loadBgmSetting(); playerHPText.textContent = playerHP; updateHPBar('playerHPBar', playerHP, playerMaxHP);

  </script>
</body>
</html>
