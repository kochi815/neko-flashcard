<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã­ã“ãƒãƒˆãƒ«ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ç­‰ --- */
        body { font-family: 'M PLUS Rounded 1c', sans-serif; text-align: center; background-color: #fdf6e3; margin: 0; padding: 15px; transition: background-color 0.3s ease-out; position: relative; min-height: 100vh; box-sizing: border-box; }
        body.boss-battle-bg { background-color: #ffebee; }
        /* â˜…è¿½åŠ : ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰èƒŒæ™¯ */
        body.training-bg { background-color: #e3f2fd; } /* è–„ã„æ°´è‰² */

        h1 { font-size: 1.8em; color: #d35400; margin-bottom: 10px; }
        button { font-family: 'M PLUS Rounded 1c', sans-serif; font-weight: bold; cursor: pointer; transition: background-color 0.2s, transform 0.1s; border: none; }
        button:active:not(:disabled) { transform: scale(0.97); }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        #bgmToggleBtn { position: absolute; top: 15px; right: 15px; font-size: 1.8em; background: none; border: none; padding: 5px; opacity: 0.7; z-index: 20; }
        #bgmToggleBtn:hover { opacity: 1; }
        #bgmToggleBtn.muted::before { content: "ğŸ”‡"; font-size: 1em; }
        #bgmToggleBtn:not(.muted)::before { content: "ğŸ”Š"; font-size: 1em; }

        /* --- ç”»é¢ã‚³ãƒ³ãƒ†ãƒŠ --- */
        .screen { display: none; /* åŸºæœ¬ã¯éè¡¨ç¤º */ padding-top: 30px; flex-direction: column; align-items: center; gap: 10px; width: 100%;}
        #modeSelectScreen { display: flex; } /* æœ€åˆã¯ãƒ¢ãƒ¼ãƒ‰é¸æŠã‚’è¡¨ç¤º */

        /* --- ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ --- */
        #modeSelectScreen h2 { font-size: 1.5em; color: #555; margin-bottom: 10px;}
        .mode-btn { font-size: 1.1em; padding: 10px 25px; border-radius: 18px; color: white; min-width: 200px; margin-bottom: 5px; } /* å°‘ã—å°ã•ã */
        #grade1ModeBtn { background-color: #87cefa; } #grade2ModeBtn { background-color: #ffb6c1; } #grade3ModeBtn { background-color: #90ee90; } #grade4ModeBtn { background-color: #ffcc80; } #grade5ModeBtn { background-color: #ba55d3; }
        #trainingModeBtn { background-color: #ff7f50; } /* ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒœã‚¿ãƒ³è‰² */
        #grade1ModeBtn:hover { background-color: #5abcd8; } #grade2ModeBtn:hover { background-color: #ff9aaa; } #grade3ModeBtn:hover { background-color: #66cdab; } #grade4ModeBtn:hover { background-color: #ffa726; } #grade5ModeBtn:hover { background-color: #9932cc; }
        #trainingModeBtn:hover { background-color: #ff6347; }

        /* --- ã‚¹ã‚¿ãƒ¼ãƒˆæ–¹æ³•é¸æŠç”»é¢ --- */
        #startMethodScreen h2 { font-size: 1.5em; color: #555; }
        .start-method-btn { font-size: 1.4em; padding: 15px 40px; border-radius: 25px; color: white; min-width: 250px; }
        #startFromBeginningBtn { background-color: #a5d6a7; } #continueFromLastBtn { background-color: #90caf9; }
        #startFromBeginningBtn:hover { background-color: #81c784; } #continueFromLastBtn:hover:not(:disabled) { background-color: #64b5f6; }

        /* --- â˜…è¿½åŠ : ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¿ã‚¤ãƒ—é¸æŠç”»é¢ --- */
        #trainingTypeSelectScreen { gap: 15px; }
        #trainingTypeSelectScreen h2 { font-size: 1.5em; color: #555; }
        .training-type-btn { font-size: 1.2em; padding: 12px 30px; border-radius: 20px; color: white; min-width: 280px; background-color: #4db6ac; }
         .training-type-btn:hover { background-color: #26a69a; }
        #backToModeSelectBtn { font-size: 1em; padding: 8px 20px; background-color: #bdbdbd; color: #fff; border-radius: 15px; }
        #backToModeSelectBtn:hover { background-color: #9e9e9e;}

        /* --- ãƒãƒˆãƒ«ç”»é¢ --- */
        #battleScreen { gap: 10px; }
        .character-area { border: 2px solid #eee; border-radius: 10px; padding: 10px; margin: 5px 0; width: 90%; max-width: 400px; background-color: rgba(255, 255, 255, 0.8); box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; } #enemyArea { border-color: #e74c3c; } #playerArea { border-color: #3498db; } .character-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-weight: bold; } .character-name { font-size: 1.1em; } .character-hp-text { font-size: 1em; } .hp-bar-container { height: 15px; background-color: #eee; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; } .hp-bar { height: 100%; width: 100%; border-radius: 6px; transition: width 0.3s ease-in-out; } #enemyArea .hp-bar { background-color: #f44336; } #playerArea .hp-bar { background-color: #4caf50; } .character-display { font-size: 3em; margin: 5px 0; transition: transform 0.1s ease-in-out, opacity 0.3s ease-out; opacity: 1; } .character-display.defeated { opacity: 0; transform: scale(0.5) rotate(30deg); } #question { font-size: 2.2em; margin: 15px 0; color: #2c3e50; font-weight: 700; min-height: 1.3em; } #answerChoices { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 10px; margin-bottom: 10px; } .choice-btn { font-size: 1.3em; padding: 10px 18px; border-radius: 8px; border: 2px solid #f39c12; background-color: #fff; color: #333; min-width: 70px; } .choice-btn:hover:not(:disabled) { background-color: #fef9e7; } .choice-btn:disabled { background-color: #eee; border-color: #ccc; color: #aaa; } #battleLog { font-size: 1.1em; min-height: 1.5em; margin: 10px 0; color: #c0392b; font-weight: bold; } #startBtn { font-size: 1.1em; padding: 10px 30px; margin: 15px 0 5px 0; border-radius: 20px; background-color: #e67e22; color: white; min-width: 160px; } #startBtn:hover { background-color: #d35400; }

        /* --- â˜…è¿½åŠ : ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”»é¢ --- */
        #trainingScreen { gap: 15px; }
        #trainingStatus { display: flex; justify-content: space-around; width: 90%; max-width: 400px; font-size: 1.4em; font-weight: bold;}
        #trainingTimer { color: #ff9800; }
        #trainingScore { color: #4caf50; }
        #trainingEnemyDisplay { font-size: 4em; margin: 10px 0; transition: opacity 0.2s, transform 0.2s; } /* ã‚¹ãƒ©ã‚¤ãƒ è¡¨ç¤º */
        #trainingEnemyDisplay.defeated { opacity: 0; transform: scale(0.5); }
        #trainingQuestion { font-size: 2.5em; margin: 10px 0; color: #2c3e50; font-weight: 700; min-height: 1.3em; }
        #trainingAnswerChoices { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 10px; margin-bottom: 10px; }

        /* --- â˜…è¿½åŠ : ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°çµæœç”»é¢ --- */
        #trainingResultScreen { gap: 15px; }
        #trainingResultScreen h2 { font-size: 1.8em; color: #00796b;}
        #finalScore { font-size: 2.5em; font-weight: bold; color: #ff6f61; }
        #personalBest { font-size: 1.2em; color: #555; }
        .result-btn-area { display: flex; gap: 15px; margin-top: 15px;}
        .result-btn { font-size: 1.1em; padding: 10px 25px; border-radius: 18px; color: white; min-width: 150px; }
        #retryTrainingBtn { background-color: #66bb6a; } #backToModeSelectBtnFromTraining { background-color: #bdbdbd; }
        #retryTrainingBtn:hover { background-color: #4caf50; } #backToModeSelectBtnFromTraining:hover { background-color: #9e9e9e; }


        /* --- å…±é€šæ¼”å‡ºç³» --- */
        #feedbackDisplay { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%) scale(0.8); font-size: 3em; font-weight: bold; color: #fff; background-color: rgba(0, 0, 0, 0.6); padding: 10px 25px; border-radius: 15px; opacity: 0; transition: opacity 0.2s ease-out, transform 0.2s ease-out; pointer-events: none; z-index: 10; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); } #feedbackDisplay.show { opacity: 1; transform: translate(-50%, -50%) scale(1); } #feedbackDisplay.critical { color: #ffeb3b; } #feedbackDisplay.perfect { color: #81d4fa; } #feedbackDisplay.great { color: #a5d6a7; } #feedbackDisplay.good { color: #fff; } #feedbackDisplay.slow { color: #ef9a9a; } #feedbackDisplay.wrong { color: #f44336; background-color: rgba(255, 255, 255, 0.8); text-shadow: none;}
        #comboDisplay { position: absolute; top: 60%; left: 50%; transform: translateX(-50%); font-size: 2.5em; font-weight: bold; color: #ff9800; opacity: 0; transition: opacity 0.2s, transform 0.2s; pointer-events: none; z-index: 5; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); } #comboDisplay.show { opacity: 1; animation: comboBounce 0.3s ease-out; } #comboDisplay.great-combo { color: #f44336; } #comboDisplay.amazing-combo { color: #9c27b0; }
        @keyframes comboBounce { 0% { transform: translateX(-50%) scale(0.8); } 50% { transform: translateX(-50%) scale(1.1); } 100% { transform: translateX(-50%) scale(1); } } @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px); } 50% { transform: translateX(3px); } 75% { transform: translateX(-3px); } } .shake-animation { animation: shake 0.2s ease-in-out; } body.feedback-flash { background-color: #fff3e0; }
        @media (max-width: 600px) { h1 { font-size: 1.6em; } .character-display { font-size: 2.5em; } #question, #trainingQuestion { font-size: 1.8em; } .choice-btn { font-size: 1.1em; padding: 8px 15px; min-width: 60px; } #startBtn { font-size: 1em; padding: 10px 25px; min-width: 140px; } #battleLog { font-size: 1em; } #feedbackDisplay { font-size: 2.5em; padding: 8px 20px;} #comboDisplay { font-size: 2em; top: 55%; } #bgmToggleBtn { font-size: 1.5em; top: 10px; right: 10px; } .mode-btn, .start-method-btn, .training-type-btn { font-size: 1.1em; padding: 10px 25px; min-width: 180px; } .result-btn { font-size: 1em; padding: 10px 20px; min-width: 130px; } #trainingStatus { font-size: 1.2em;} }
    </style>
</head>
<body>
    <h1>ã­ã“ãƒãƒˆãƒ«ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h1>
    <button id="bgmToggleBtn">ğŸ”Š</button>

    <div id="modeSelectScreen" class="screen">
        <h2>ãƒ¢ãƒ¼ãƒ‰ã‚’é¸ã‚“ã§ã­ï¼</h2>
        <button id="grade1ModeBtn" class="mode-btn">ğŸ’ ï¼‘ã­ã‚“ã›ã„</button>
        <button id="grade2ModeBtn" class="mode-btn">ğŸ’ ï¼’ã­ã‚“ã›ã„</button>
        <button id="grade3ModeBtn" class="mode-btn">ğŸ“š ï¼“ã­ã‚“ã›ã„</button>
        <button id="grade4ModeBtn" class="mode-btn">ğŸ“š ï¼”ã­ã‚“ã›ã„</button>
        <button id="grade5ModeBtn" class="mode-btn">ğŸ“ ï¼•ã­ã‚“ã›ã„</button>
        <button id="trainingModeBtn" class="mode-btn">ğŸ’ª ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</button> </div>

    <div id="startMethodScreen" class="screen"> <h2>ã©ã†ã‚„ã£ã¦ã¯ã˜ã‚ã‚‹ï¼Ÿ</h2> <button id="startFromBeginningBtn" class="start-method-btn">ã¯ã˜ã‚ã‹ã‚‰ (Lv 1)</button> <button id="continueFromLastBtn" class="start-method-btn" style="display: none;">ã¤ã¥ãã‹ã‚‰ (Lv X)</button> </div>

    <div id="battleScreen" class="screen"> <div id="enemyArea" class="character-area"> <div class="character-info"> <span class="character-name" id="enemyName"></span> <span class="character-hp-text">HP: <span id="enemyHPText"></span></span> </div> <div class="hp-bar-container"> <div class="hp-bar" id="enemyHPBar"></div> </div> <div class="character-display" id="enemyCharacter"></div> </div> <div id="questionArea"> <div id="question"></div> <div id="answerChoices"></div> </div> <div id="playerArea" class="character-area"> <div class="character-display" id="playerCharacter">ğŸ˜º</div> <div class="hp-bar-container"> <div class="hp-bar" id="playerHPBar"></div> </div> <div class="character-info"> <span class="character-name">ã«ã‚ƒã‚“ãŸã‚ã†</span> <span class="character-hp-text">HP: <span id="playerHPText"></span></span> </div> </div> <div id="infoArea"> <div id="battleLog"></div> <button id="startBtn"></button> </div> </div>

    <div id="trainingTypeSelectScreen" class="screen">
        <h2>ã‚Œã‚“ã—ã‚…ã†ã™ã‚‹ ãªã„ã‚ˆã† ã‚’ ãˆã‚‰ã‚“ã§ã­ï¼</h2>
        <button class="training-type-btn" data-training-type="addsub1">ã‹ã‚“ãŸã‚“ ãŸã—ç®—ãƒ»ã²ãç®—</button>
        <button class="training-type-btn" data-training-type="addsub2">ãµã¤ã† ãŸã—ç®—ãƒ»ã²ãç®—</button>
        <button class="training-type-btn" data-training-type="mul">ã‹ã‘ç®— (ä¹ä¹ãƒã‚¹ã‚¿ãƒ¼)</button>
        <button class="training-type-btn" data-training-type="div">ã‚ã‚Šç®— (ã‚ã¾ã‚Šãªã—)</button>
        <button id="backToModeSelectBtn">ã‚‚ã©ã‚‹</button>
    </div>

    <div id="trainingScreen" class="screen">
        <div id="trainingStatus">
            <span id="trainingTimer">ã®ã“ã‚Šæ™‚é–“: 60ç§’</span>
            <span id="trainingScore">ãŸãŠã—ãŸæ•°: 0</span>
        </div>
        <div id="trainingEnemyDisplay">ğŸ’§</div> <div id="trainingQuestion"></div>
        <div id="trainingAnswerChoices"></div>
    </div>

    <div id="trainingResultScreen" class="screen">
        <h2>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° ãŠã‚ã‚Šï¼</h2>
        <div>ã‘ã£ã‹ ã¯ã£ã´ã‚‡ã†ï¼</div>
        <div id="finalScore" style="margin: 15px 0;">0 ã²ã ãŸãŠã—ãŸï¼</div>
        <div id="personalBest">ã˜ã“ãƒ™ã‚¹ãƒˆ: 0 ã²ã</div>
        <div class="result-btn-area">
            <button id="retryTrainingBtn" class="result-btn">ã‚‚ã†ä¸€å›ï¼</button>
            <button id="backToModeSelectBtnFromTraining" class="result-btn">ãƒ¢ãƒ¼ãƒ‰é¸æŠã¸</button>
        </div>
    </div>

    <div id="feedbackDisplay"></div> <div id="comboDisplay"></div>

  <script>
    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ç­‰ ---
    let currentStage = 1; let gameMode = ''; // 'grade1'...'grade5' or 'training'
    let playerMaxHP = 15; let playerHP = playerMaxHP;
    let currentEnemy = {}; let enemyMaxHP = 10; let enemyHP = enemyMaxHP;
    let problems = []; let currentProblemIndex = 0; let questionStartTime;
    let battleInProgress = false; let comboCount = 0; let isBgmEnabled = true;
    const BGM_KEY = 'nekobattle_bgmEnabled_v1'; let questionsForThisStage = 15; // é€šå¸¸15å•
    const HIGHEST_STAGE_KEY_PREFIX = 'nekobattle_highestStage_'; let highestClearedStage = 0;
    // â˜…è¿½åŠ : ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”¨å¤‰æ•°
    let trainingType = ''; let trainingTimeLimit = 60; let trainingTimeRemaining = trainingTimeLimit; let trainingScore = 0; let trainingTimerInterval = null; const BEST_SCORE_KEY_PREFIX = 'nekobattle_bestScore_'; let currentTrainingProblem = null;

    // --- DOMè¦ç´ å–å¾— ---
    const modeSelectScreen = document.getElementById("modeSelectScreen"); const grade1ModeBtn = document.getElementById("grade1ModeBtn"); const grade2ModeBtn = document.getElementById("grade2ModeBtn"); const grade3ModeBtn = document.getElementById("grade3ModeBtn"); const grade4ModeBtn = document.getElementById("grade4ModeBtn"); const grade5ModeBtn = document.getElementById("grade5ModeBtn");
    const trainingModeBtn = document.getElementById("trainingModeBtn"); // â˜…è¿½åŠ 
    const startMethodScreen = document.getElementById("startMethodScreen"); const startFromBeginningBtn = document.getElementById("startFromBeginningBtn"); const continueFromLastBtn = document.getElementById("continueFromLastBtn"); const battleScreen = document.getElementById("battleScreen"); const startBtn = document.getElementById("startBtn"); const questionDiv = document.getElementById("question"); const answerChoicesDiv = document.getElementById("answerChoices"); const battleLog = document.getElementById("battleLog"); const enemyArea = document.getElementById("enemyArea"); const enemyName = document.getElementById("enemyName"); const enemyHPText = document.getElementById("enemyHPText"); const enemyHPBar = document.getElementById("enemyHPBar"); const enemyCharacter = document.getElementById("enemyCharacter"); const playerArea = document.getElementById("playerArea"); const playerHPText = document.getElementById("playerHPText"); const playerHPBar = document.getElementById("playerHPBar"); const playerCharacter = document.getElementById("playerCharacter"); const feedbackDisplay = document.getElementById("feedbackDisplay"); const comboDisplay = document.getElementById("comboDisplay"); const bgmToggleBtn = document.getElementById("bgmToggleBtn");
    // â˜…è¿½åŠ : ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”»é¢è¦ç´ 
    const trainingTypeSelectScreen = document.getElementById("trainingTypeSelectScreen");
    const trainingScreen = document.getElementById("trainingScreen");
    const trainingTimer = document.getElementById("trainingTimer");
    const trainingScore = document.getElementById("trainingScore");
    const trainingEnemyDisplay = document.getElementById("trainingEnemyDisplay");
    const trainingQuestion = document.getElementById("trainingQuestion");
    const trainingAnswerChoices = document.getElementById("trainingAnswerChoices");
    const trainingResultScreen = document.getElementById("trainingResultScreen");
    const finalScore = document.getElementById("finalScore");
    const personalBest = document.getElementById("personalBest");
    const retryTrainingBtn = document.getElementById("retryTrainingBtn");
    const backToModeSelectBtn = document.getElementById("backToModeSelectBtn");
    const backToModeSelectBtnFromTraining = document.getElementById("backToModeSelectBtnFromTraining");


    // --- åŠ¹æœéŸ³ã¨BGM ---
    const sounds = { tap: new Audio('tap.mp3'), hitEnemy: new Audio('hit_enemy.mp3'), hitPlayer: new Audio('hit_player.mp3'), wrong: new Audio('wrong.mp3'), enemyDefeated: new Audio('enemy_defeated.mp3'), criticalHit: new Audio('critical_hit.mp3'), bgmNormal: new Audio('bgm_normal.mp3'), bgmBoss: new Audio('bgm_boss.mp3'),
                     bgmTraining: new Audio('bgm_training.mp3'), // â˜…è¿½åŠ : ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°BGM (ãƒ•ã‚¡ã‚¤ãƒ«åæ³¨æ„ï¼)
                     // timesUp: new Audio('sounds/times_up.mp3') // â˜…ä»»æ„: ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—éŸ³
                   };
    sounds.bgmNormal.loop = true; sounds.bgmBoss.loop = true; sounds.bgmTraining.loop = true; // â˜…è¿½åŠ : ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°BGMã‚‚ãƒ«ãƒ¼ãƒ—
    sounds.bgmNormal.volume = 0.4; sounds.bgmBoss.volume = 0.35; sounds.bgmTraining.volume = 0.4; // â˜…è¿½åŠ : ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°BGMéŸ³é‡
    let currentBgm = null;
    function playSound(soundName) { if (!sounds[soundName]) return; sounds[soundName].currentTime = 0; sounds[soundName].play().catch(error => console.log(`Sound play failed (${soundName}):`, error)); }
    function playBgm(bgmName) { if (!isBgmEnabled || !sounds[bgmName]) return; stopBgm(); // â˜…ä¿®æ­£: å¿…ãšå‰ã®BGMã‚’åœæ­¢ã—ã¦ã‹ã‚‰å†ç”Ÿ
                       sounds[bgmName].play().catch(error => console.log(`BGM play failed (${bgmName}):`, error)); currentBgm = sounds[bgmName]; }
    function stopBgm() { if (currentBgm) { currentBgm.pause(); currentBgm.currentTime = 0; currentBgm = null; } }
    function updateBgmButton() { /* ... çœç•¥ ... */ } function loadBgmSetting() { /* ... çœç•¥ ... */ }
    bgmToggleBtn.addEventListener('click', () => { /* ... çœç•¥ ... */ isBgmEnabled = !isBgmEnabled; localStorage.setItem(BGM_KEY, JSON.stringify(isBgmEnabled)); updateBgmButton(); if (isBgmEnabled) { if (!currentBgm && (battleInProgress || gameMode === 'training')) { if(gameMode === 'training') playBgm('bgmTraining'); else if (currentEnemy) playBgm(currentEnemy.type === 'boss' ? 'bgmBoss' : 'bgmNormal'); } } else { stopBgm(); } playSound('tap'); });

    // --- æ•µãƒ‡ãƒ¼ã‚¿ Lv40ã¾ã§ (å¤‰æ›´ãªã—) ---
    const enemies = { /* ... çœç•¥ ... */ }; const maxStage = Object.keys(enemies).length;
    // --- localStorageé–¢é€£ (å¤‰æ›´ãªã—) ---
    function getHighestStageKey(mode) { return `${HIGHEST_STAGE_KEY_PREFIX}${mode}_v2`; }
    function saveHighestStage(mode, stage) { const key = getHighestStageKey(mode); const currentHighest = loadHighestStage(mode); if (stage > currentHighest && stage <= maxStage) { localStorage.setItem(key, stage.toString()); } }
    function loadHighestStage(mode) { const key = getHighestStageKey(mode); const savedStage = localStorage.getItem(key); return savedStage ? parseInt(savedStage, 10) : 0; }
    // â˜…è¿½åŠ : ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢ä¿å­˜ç”¨
    function getBestScoreKey(type) { return `${BEST_SCORE_KEY_PREFIX}${type}`; }
    function saveBestScore(type, score) { const key = getBestScoreKey(type); const currentBest = loadBestScore(type); if (score > currentBest) { localStorage.setItem(key, score.toString()); return true; /* New record */ } return false; }
    function loadBestScore(type) { const key = getBestScoreKey(type); const savedScore = localStorage.getItem(key); return savedScore ? parseInt(savedScore, 10) : 0; }

    // --- å•é¡Œç”Ÿæˆé–¢æ•° (5ãƒ¢ãƒ¼ãƒ‰, Lv40å¯¾å¿œ, å¤‰æ›´ãªã—) ---
    function generateProblems(stage, mode, count) { /* ... çœç•¥ ... */ }
    // --- é¸æŠè‚¢ç”Ÿæˆé–¢æ•° (å¤‰æ›´ãªã—) ---
    function generateChoices(correct) { /* ... çœç•¥ ... */ }
    // --- HPãƒãƒ¼æ›´æ–°é–¢æ•° (å¤‰æ›´ãªã—) ---
    function updateHPBar(elementId, currentHP, maxHP) { /* ... çœç•¥ ... */ }
    // --- ã‚­ãƒ£ãƒ©æºã‚Œé–¢æ•° (å¤‰æ›´ãªã—) ---
    function shakeCharacter(elementId) { /* ... çœç•¥ ... */ }
    // --- æ™‚é–“è©•ä¾¡è¡¨ç¤ºé–¢æ•° (å¤‰æ›´ãªã—) ---
    function showFeedback(text, type) { /* ... çœç•¥ ... */ }
    // --- ã‚³ãƒ³ãƒœè¡¨ç¤ºæ›´æ–°é–¢æ•° (å¤‰æ›´ãªã—) ---
    function updateComboDisplay() { /* ... çœç•¥ ... */ }
    // --- showQuestioné–¢æ•° (å¤‰æ›´ãªã—) ---
    function showQuestion() { /* ... çœç•¥ ... */ }
    // --- â˜… handleAnsweré–¢æ•° (é›£æ˜“åº¦å¾®èª¿æ•´ã€åŠ¹æœéŸ³ä¿®æ­£) â˜… ---
    function handleAnswer(selectedAnswer) {
        if (battleInProgress) return; battleInProgress = true;
        const choiceButtons = answerChoicesDiv.querySelectorAll('.choice-btn');
        choiceButtons.forEach(btn => btn.disabled = true); playSound('tap');
        const elapsed = (Date.now() - questionStartTime) / 1000; const p = problems[currentProblemIndex];
        let feedbackClass = ''; let damageToEnemy = 0; let damageToPlayer = 0; let logMessage = ""; let feedbackText = ""; let feedbackType = ""; let isCritical = false;
        let criticalTime, perfectTime, greatTime, goodTime, slowPenalty, wrongPenalty, baseDmgCrit, baseDmgPerf, baseDmgGreat, baseDmgGood;
        // â˜…é›£æ˜“åº¦å¾®èª¿æ•´: G4, G5ã®æ™‚é–“åŸºæº–ç·©å’Œâ˜…
        switch (gameMode) {
            case 'grade1': criticalTime = 3.0; perfectTime = 5.0; greatTime = 7.0; goodTime = 10.0; slowPenalty = 0; wrongPenalty = 1; baseDmgCrit = 6; baseDmgPerf = 4; baseDmgGreat = 2; baseDmgGood = 1; break;
            case 'grade2': criticalTime = 2.0; perfectTime = 3.5; greatTime = 5.0; goodTime = 7.5; slowPenalty = 1; wrongPenalty = 1; baseDmgCrit = 6; baseDmgPerf = 4; baseDmgGreat = 2; baseDmgGood = 1; break;
            case 'grade3': criticalTime = 1.5; perfectTime = 2.5; greatTime = 4.0; goodTime = 6.0; slowPenalty = 1; wrongPenalty = 2; baseDmgCrit = 5; baseDmgPerf = 3; baseDmgGreat = 2; baseDmgGood = 1; break;
            case 'grade4': criticalTime = 1.1; perfectTime = 2.0; greatTime = 3.5; goodTime = 5.0; slowPenalty = 2; wrongPenalty = 2; baseDmgCrit = 6; baseDmgPerf = 4; baseDmgGreat = 2; baseDmgGood = 1; break; // ç·©å’Œ
            case 'grade5': criticalTime = 0.9; perfectTime = 1.7; greatTime = 2.8; goodTime = 4.3; slowPenalty = 2; wrongPenalty = 3; baseDmgCrit = 6; baseDmgPerf = 4; baseDmgGreat = 2; baseDmgGood = 1; break; // ç·©å’Œ
            default: criticalTime = 1.5; perfectTime = 2.5; greatTime = 4.0; goodTime = 6.0; slowPenalty = 1; wrongPenalty = 2; baseDmgCrit = 5; baseDmgPerf = 3; baseDmgGreat = 2; baseDmgGood = 1;
        }
        if (selectedAnswer === p.a) { // æ­£è§£
            comboCount++; let baseDamage = 0;
            if (elapsed < criticalTime) { baseDamage = baseDmgCrit; logMessage = `âœ¨Critical Hit!âœ¨ (${elapsed.toFixed(1)}ç§’) `; feedbackText = "Critical Hit!"; feedbackType = "critical"; isCritical = true; }
            else if (elapsed < perfectTime) { baseDamage = baseDmgPerf; logMessage = `Perfect! (${elapsed.toFixed(1)}ç§’) `; feedbackText = "Perfect!"; feedbackType = "perfect"; }
            else if (elapsed < greatTime) { baseDamage = baseDmgGreat; logMessage = `Great! (${elapsed.toFixed(1)}ç§’) `; feedbackText = "Great!"; feedbackType = "great"; }
            else if (elapsed < goodTime) { baseDamage = baseDmgGood; logMessage = `Good (${elapsed.toFixed(1)}ç§’) `; feedbackText = "Good"; feedbackType = "good"; }
            else { damageToPlayer = slowPenalty; logMessage = `Too slow... (${elapsed.toFixed(1)}ç§’) ${damageToPlayer>0 ? `è‡ªåˆ†ã«${damageToPlayer}ãƒ€ãƒ¡ãƒ¼ã‚¸!` : 'ãƒ€ãƒ¡ãƒ¼ã‚¸ãªã—'}`; feedbackText = "Too Slow..."; feedbackType = "slow"; comboCount = 0; }
            let comboBonus = 0; if (comboCount >= 5) comboBonus = 2; else if (comboCount >= 3) comboBonus = 1;
            damageToEnemy = baseDamage + comboBonus;
            if(damageToEnemy > 0) { logMessage += `æ•µã«${damageToEnemy}ãƒ€ãƒ¡ãƒ¼ã‚¸!`; if (comboCount >= 3) logMessage += ` (${comboCount} Combo!)`; feedbackClass = 'feedback-flash'; shakeCharacter('enemyCharacter'); playSound('hitEnemy'); if(isCritical) playSound('criticalHit'); } // â˜…ã‚µã‚¦ãƒ³ãƒ‰ä¿®æ­£æ¸ˆ
            else if (damageToPlayer > 0) { feedbackClass = 'feedback-damage-player'; shakeCharacter('playerCharacter'); playSound('hitPlayer'); }
            else { feedbackClass = 'feedback-correct'; }
        } else { // ä¸æ­£è§£
            damageToPlayer = wrongPenalty; logMessage = `Wrong! è‡ªåˆ†ã«${damageToPlayer}ãƒ€ãƒ¡ãƒ¼ã‚¸!`; feedbackText = "Wrong!"; feedbackType = "wrong"; feedbackClass = 'feedback-wrong'; comboCount = 0; shakeCharacter('playerCharacter');
            playSound('wrong'); playSound('hitPlayer'); // â˜…ã‚µã‚¦ãƒ³ãƒ‰ä¿®æ­£: ä¸¡æ–¹é³´ã‚‰ã™
        }
        updateComboDisplay(); enemyHP -= damageToEnemy; playerHP -= damageToPlayer;
        enemyHPText.textContent = Math.max(0, enemyHP); playerHPText.textContent = Math.max(0, playerHP); updateHPBar('enemyHPBar', enemyHP, enemyMaxHP); updateHPBar('playerHPBar', playerHP, playerMaxHP);
        battleLog.textContent = logMessage; if(feedbackText) showFeedback(feedbackText, feedbackType);
        if (feedbackClass) { document.body.classList.add(feedbackClass); setTimeout(() => { document.body.classList.remove(feedbackClass); }, 150); }
        currentProblemIndex++;
        setTimeout(() => { if (playerHP <= 0 || enemyHP <= 0 || currentProblemIndex >= questionsForThisStage) { endBattle(); } else { showQuestion(); } }, 1000);
    }

    // --- â˜… startBattleé–¢æ•° (HPè£œæ­£5ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œå¾®èª¿æ•´) â˜… ---
    function startBattle() {
        currentEnemy = enemies[currentStage] || enemies[maxStage];
        if (!currentEnemy) { console.error("Error: Cannot find enemy data for stage", currentStage); return; }
        enemyMaxHP = currentEnemy.hp;
        if (currentEnemy.type === 'boss') { enemyMaxHP = Math.floor(enemyMaxHP * 1.5); }
        let hpMultiplier = 1.0; // â˜…5ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ HPå€ç‡èª¿æ•´â˜…
        switch (gameMode) { case 'grade1': hpMultiplier = 0.5; break; case 'grade2': hpMultiplier = 0.7; break; case 'grade3': hpMultiplier = 0.9; break; case 'grade4': hpMultiplier = 0.95; break; /* 1.0 -> 0.95 */ case 'grade5': hpMultiplier = 1.0; break; /* 1.1 -> 1.0 */ }
        enemyMaxHP = Math.max(5, Math.floor(enemyMaxHP * hpMultiplier));
        enemyHP = enemyMaxHP; playerHP = playerMaxHP; currentProblemIndex = 0; comboCount = 0; updateComboDisplay();
        questionsForThisStage = (currentEnemy.type === 'boss') ? 20 : 15;
        problems = generateProblems(currentStage, gameMode, questionsForThisStage);
        if (!problems || problems.length === 0) { console.error("Error: generateProblems returned empty!", {currentStage, gameMode, questionsForThisStage}); battleLog.textContent = "ã‚¨ãƒ©ãƒ¼ï¼šå•é¡Œç”Ÿæˆå¤±æ•—"; return; }
        enemyName.textContent = `${currentEnemy.emoji} ${currentEnemy.name} (Lv${currentStage})`; enemyHPText.textContent = enemyHP; playerHPText.textContent = playerHP; updateHPBar('enemyHPBar', enemyHP, enemyMaxHP); updateHPBar('playerHPBar', playerHP, playerMaxHP); enemyCharacter.textContent = currentEnemy.emoji; enemyCharacter.classList.remove('defeated');
        stopBgm(); if (currentEnemy.type === 'boss') { document.body.classList.add('boss-battle-bg'); battleLog.textContent = `ğŸ”¥ãƒœã‚¹å‡ºç¾ï¼ ${currentEnemy.name} ãŒã‚ã‚‰ã‚ã‚ŒãŸï¼ğŸ”¥`; playBgm('bgmBoss'); } else { document.body.classList.remove('boss-battle-bg'); battleLog.textContent = `Lv${currentStage} ${currentEnemy.name} ãŒã‚ã‚‰ã‚ã‚ŒãŸï¼`; playBgm('bgmNormal'); }
        startBtn.style.display = "none"; battleInProgress = false; setTimeout(showQuestion, 1500);
    }
    // --- endBattleé–¢æ•° (å¤‰æ›´ãªã—) ---
    function endBattle() { battleInProgress = true; answerChoicesDiv.innerHTML = ""; questionDiv.textContent = "Battle End!"; comboDisplay.classList.remove('show'); stopBgm(); let resultMessage = ""; let nextButtonText = ""; let isVictory = false; if (enemyHP <= 0) { isVictory = true; playSound('enemyDefeated'); enemyCharacter.classList.add('defeated'); resultMessage = `ğŸ‰å‹åˆ©ï¼ ${currentEnemy.name} ã‚’ãŸãŠã—ãŸï¼ğŸ‰`; if (currentEnemy.type === 'boss') { resultMessage += ` ã™ã”ã„ï¼ãƒœã‚¹ã‚’æ’ƒç ´ã—ãŸãï¼`; } saveHighestStage(gameMode, currentStage); currentStage++; if (currentStage > maxStage) { resultMessage += " ğŸ†å…¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ï¼ãŠã‚ã§ã¨ã†ï¼ğŸ†"; startBtn.style.display = "none"; } else { nextButtonText = `æ¬¡ã®æ•µ (Lv${currentStage}) ã¨æˆ¦ã†ï¼`; startBtn.style.display = "inline-block"; } } else { resultMessage = playerHP <= 0 ? "ğŸ˜­æ•—åŒ—...ã¾ãŸæŒ‘æˆ¦ã—ã¦ã­ï¼" : "æ™‚é–“åˆ‡ã‚Œ...ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ï¼"; nextButtonText = "å†æŒ‘æˆ¦ï¼"; startBtn.style.display = "inline-block"; } battleLog.textContent = resultMessage; if (nextButtonText) { startBtn.textContent = nextButtonText; } document.body.classList.add(isVictory ? 'feedback-correct' : 'feedback-wrong'); setTimeout(() => { document.body.classList.remove('feedback-correct', 'feedback-wrong', 'boss-battle-bg'); }, 1000); }

    // --- â˜… ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰é–¢é€£é–¢æ•° â˜… ---
    function generateTrainingProblem(type) {
        let num1, num2, answer, questionText, op;
        switch (type) {
            case 'addsub1': // ã‹ã‚“ãŸã‚“ ãŸã—ç®—ãƒ»ã²ãç®—
                if (Math.random() < 0.6) { op = '+'; do { num1 = Math.floor(Math.random() * 10); num2 = Math.floor(Math.random() * (10 - num1)); } while (num1 === 0 && num2 === 0); answer = num1 + num2; }
                else { op = '-'; num1 = Math.floor(Math.random() * 6) + 5; num2 = Math.floor(Math.random() * num1) + 1; answer = num1 - num2; }
                break;
            case 'addsub2': // ãµã¤ã† ãŸã—ç®—ãƒ»ã²ãç®—
                 if (Math.random() < 0.5) { op = '+'; num1 = Math.floor(Math.random()*80)+10; num2 = Math.floor(Math.random()*80)+10; answer = num1 + num2; }
                 else { op = '-'; num1 = Math.floor(Math.random()*80)+20; num2 = Math.floor(Math.random()*(num1-10))+10; answer = num1 - num2; }
                 break;
            case 'mul': // ã‹ã‘ç®—ï¼ˆä¹ä¹ï¼‰
                op = 'Ã—'; num1 = Math.floor(Math.random() * 8) + 2; num2 = Math.floor(Math.random() * 8) + 2; answer = num1 * num2;
                break;
            case 'div': // ã‚ã‚Šç®—ï¼ˆã‚ã¾ã‚Šãªã—ï¼‰
                op = 'Ã·'; num2 = Math.floor(Math.random() * 8) + 2; answer = Math.floor(Math.random() * 8) + 2; num1 = num2 * answer;
                break;
            default: // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç°¡å˜ãªãŸã—ç®—
                 op = '+'; do { num1 = Math.floor(Math.random() * 10); num2 = Math.floor(Math.random() * (10 - num1)); } while (num1 === 0 && num2 === 0); answer = num1 + num2;
        }
        questionText = `${num1} ${op} ${num2}`;
        return { q: questionText, a: answer };
    }

    function showTrainingQuestion() {
        if (trainingTimeRemaining <= 0) return; // æ™‚é–“åˆ‡ã‚Œãªã‚‰ä½•ã‚‚ã—ãªã„
        currentTrainingProblem = generateTrainingProblem(trainingType);
        trainingQuestion.textContent = currentTrainingProblem.q;
        const choices = generateChoices(currentTrainingProblem.a);
        trainingAnswerChoices.innerHTML = "";
        trainingEnemyDisplay.classList.remove('defeated'); // ã‚¹ãƒ©ã‚¤ãƒ è¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
        choices.forEach(choice => {
            const btn = document.createElement("button");
            btn.textContent = choice;
            btn.className = "choice-btn"; // ãƒãƒˆãƒ«ãƒ¢ãƒ¼ãƒ‰ã¨åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«æµç”¨
            btn.onclick = () => handleTrainingAnswer(choice);
            trainingAnswerChoices.appendChild(btn);
        });
         battleInProgress = false; // å›ç­”å—ä»˜å¯èƒ½ã«
    }

    function handleTrainingAnswer(selectedAnswer) {
        if (battleInProgress || trainingTimeRemaining <= 0) return; // å‡¦ç†ä¸­oræ™‚é–“åˆ‡ã‚Œã¯ç„¡è¦–
        battleInProgress = true; // å‡¦ç†é–‹å§‹
        const choiceButtons = trainingAnswerChoices.querySelectorAll('.choice-btn');
        choiceButtons.forEach(btn => btn.disabled = true);
        playSound('tap');

        if (selectedAnswer === currentTrainingProblem.a) { // æ­£è§£
            playSound('hitEnemy'); // æ­£è§£ï¼ãƒ’ãƒƒãƒˆéŸ³
            showFeedback("Correct!", "perfect"); // æ­£è§£ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            trainingScore++;
            trainingScore.textContent = `ãŸãŠã—ãŸæ•°: ${trainingScore}`;
            // ã‚¹ãƒ©ã‚¤ãƒ æ’ƒç ´æ¼”å‡º
            trainingEnemyDisplay.classList.add('defeated');
            playSound('enemyDefeated'); // ç°¡æ˜“çš„ãªæ’ƒç ´éŸ³
        } else { // ä¸æ­£è§£
            playSound('wrong');
            showFeedback("Wrong!", "wrong");
            trainingTimeRemaining = Math.max(0, trainingTimeRemaining - 1); // æ™‚é–“ãƒšãƒŠãƒ«ãƒ†ã‚£-1ç§’
            trainingTimer.textContent = `ã®ã“ã‚Šæ™‚é–“: ${trainingTimeRemaining}ç§’`;
        }
        // ã™ãã«æ¬¡ã®å•é¡Œã¸ (0.2ç§’å¾Œãã‚‰ã„)
        setTimeout(showTrainingQuestion, 200);
    }

    function updateTrainingTimer() {
        trainingTimeRemaining--;
        trainingTimer.textContent = `ã®ã“ã‚Šæ™‚é–“: ${trainingTimeRemaining}ç§’`;
        if (trainingTimeRemaining <= 0) {
            endTraining();
        }
    }

    function startTraining(type) {
        gameMode = 'training'; // ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰è¨­å®š
        trainingType = type;
        trainingScore = 0;
        trainingTimeRemaining = trainingTimeLimit;
        battleInProgress = false;

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        modeSelectScreen.style.display = 'none';
        trainingTypeSelectScreen.style.display = 'none';
        battleScreen.style.display = 'none';
        trainingScreen.style.display = 'flex'; // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”»é¢è¡¨ç¤º
        trainingResultScreen.style.display = 'none';
        document.body.className = 'training-bg'; // èƒŒæ™¯å¤‰æ›´

        // UIåˆæœŸåŒ–
        trainingTimer.textContent = `ã®ã“ã‚Šæ™‚é–“: ${trainingTimeRemaining}ç§’`;
        trainingScore.textContent = `ãŸãŠã—ãŸæ•°: ${trainingScore}`;
        trainingEnemyDisplay.textContent = 'ğŸ’§'; // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¹ãƒ©ã‚¤ãƒ 

        stopBgm(); // ä»–ã®BGMã‚’åœæ­¢
        playBgm('bgmTraining'); // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°BGMé–‹å§‹

        showTrainingQuestion(); // æœ€åˆã®å•é¡Œè¡¨ç¤º
        trainingTimerInterval = setInterval(updateTrainingTimer, 1000); // ã‚¿ã‚¤ãƒãƒ¼ã‚¹ã‚¿ãƒ¼ãƒˆ
    }

    function endTraining() {
        clearInterval(trainingTimerInterval); // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
        battleInProgress = true; // å›ç­”ä¸å¯ã«ã™ã‚‹
        stopBgm();
        // playSound('timesUp'); // â˜…ä»»æ„: ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—éŸ³

        // çµæœè¡¨ç¤º
        finalScore.textContent = `${trainingScore} ã²ã ãŸãŠã—ãŸï¼`;
        const bestScore = loadBestScore(trainingType);
        personalBest.textContent = `ã˜ã“ãƒ™ã‚¹ãƒˆ: ${bestScore} ã²ã`;
        if (saveBestScore(trainingType, trainingScore)) {
            personalBest.textContent += " âœ¨æ–°è¨˜éŒ²ï¼âœ¨";
        }

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        trainingScreen.style.display = 'none';
        trainingResultScreen.style.display = 'flex';
    }

    // --- ãƒ¢ãƒ¼ãƒ‰é¸æŠ/ã‚¹ã‚¿ãƒ¼ãƒˆæ–¹æ³•é¸æŠ é–¢é€£ ---
    function showModeSelect() {
        stopBgm(); // BGMåœæ­¢
        document.body.className = ''; // èƒŒæ™¯ãƒªã‚»ãƒƒãƒˆ
        modeSelectScreen.style.display = 'flex';
        startMethodScreen.style.display = 'none';
        battleScreen.style.display = 'none';
        trainingTypeSelectScreen.style.display = 'none';
        trainingScreen.style.display = 'none';
        trainingResultScreen.style.display = 'none';
    }

    function selectMode(selectedMode) {
        playSound('tap');
        gameMode = selectedMode;
        highestClearedStage = loadHighestStage(gameMode);
        modeSelectScreen.style.display = 'none';
        startMethodScreen.style.display = 'flex';
        if (highestClearedStage > 0 && highestClearedStage < maxStage) { const nextStage = highestClearedStage + 1; continueFromLastBtn.textContent = `ã¤ã¥ãã‹ã‚‰ (Lv ${nextStage})`; continueFromLastBtn.style.display = 'inline-block'; continueFromLastBtn.disabled = false; }
        else { continueFromLastBtn.style.display = 'none'; continueFromLastBtn.disabled = true; }
        loadBgmSetting(); // BGMè¨­å®šèª­ã¿è¾¼ã¿ã¯ã“ã“ã ã‘ã§è‰¯ã„
    }
    function startGameFlow() {
        playSound('tap');
        startMethodScreen.style.display = 'none';
        battleScreen.style.display = 'flex';
        document.body.className = ''; // èƒŒæ™¯ãƒªã‚»ãƒƒãƒˆ(ãƒœã‚¹æˆ¦ä»¥å¤–)
        startBattle();
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    grade1ModeBtn.addEventListener("click", () => selectMode('grade1'));
    grade2ModeBtn.addEventListener("click", () => selectMode('grade2'));
    grade3ModeBtn.addEventListener("click", () => selectMode('grade3'));
    grade4ModeBtn.addEventListener("click", () => selectMode('grade4'));
    grade5ModeBtn.addEventListener("click", () => selectMode('grade5'));
    trainingModeBtn.addEventListener("click", () => { // â˜…è¿½åŠ : ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰é¸æŠ
         playSound('tap');
         modeSelectScreen.style.display = 'none';
         trainingTypeSelectScreen.style.display = 'flex';
         stopBgm(); // å¿µã®ãŸã‚BGMåœæ­¢
    });
    startFromBeginningBtn.addEventListener('click', () => { currentStage = 1; startGameFlow(); });
    continueFromLastBtn.addEventListener('click', () => { currentStage = highestClearedStage + 1; if (currentStage > maxStage) currentStage = maxStage; startGameFlow(); });
    startBtn.addEventListener("click", () => { playSound('tap'); enemyCharacter.classList.remove('defeated'); startBattle(); });

    // â˜…è¿½åŠ : ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¿ã‚¤ãƒ—é¸æŠãƒœã‚¿ãƒ³
    document.querySelectorAll('.training-type-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            playSound('tap');
            const type = e.target.dataset.trainingType;
            startTraining(type);
        });
    });
    // â˜…è¿½åŠ : ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°çµæœç”»é¢ãƒœã‚¿ãƒ³
    retryTrainingBtn.addEventListener('click', () => {
        playSound('tap');
        trainingResultScreen.style.display = 'none';
        startTraining(trainingType); // åŒã˜ã‚¿ã‚¤ãƒ—ã§å†æŒ‘æˆ¦
    });
    backToModeSelectBtn.addEventListener('click', showModeSelect); // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°é¸æŠç”»é¢ç”¨
    backToModeSelectBtnFromTraining.addEventListener('click', showModeSelect); // ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°çµæœç”»é¢ç”¨


    // --- åˆæœŸåŒ–å‡¦ç† ---
    loadBgmSetting();
    playerHPText.textContent = playerHP;
    updateHPBar('playerHPBar', playerHP, playerMaxHP);
    showModeSelect(); // â˜…å¤‰æ›´: æœ€åˆã¯ãƒ¢ãƒ¼ãƒ‰é¸æŠç”»é¢ã‚’è¡¨ç¤º

  </script>
</body>
</html>
